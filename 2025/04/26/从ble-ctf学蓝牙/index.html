<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="arch3rn4r">
    
    <title>
        
            ble_ctf wp |
        
        arch3rn4r
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/font/css/brands.min.css">
    
        
            
        
            
                
<link rel="stylesheet" href="/css/custom.css">

            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"arch3rn4r.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"arch3rn4r","author":"arch3rn4r","avatar":"/images/beauty/myhead.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                    || fa-solid fa-tags","about":"/about                || fa-solid fa-user-graduate"},"first_screen":{"enable":true,"background_img":"/images/beauty/bg.jpg","background_img_dark":"https://arch3rn4r.github.io/picx-images-hosting/20240915/EYnModKVcAAy6sw.4g4g8oqoi0.webp","description":"这里是雨季，你那里阳光明媚吗","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":true,"hide_header":true},"home":{"announcement":null,"category":false,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":false,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":"ture"},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":true,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default","code_block_shrink":false},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"left"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"giscus","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":"arch3rn4r/arch3rn4r.github.io","repo_id":"R_kgDOLnMFhw","category":"Announcements","category_id":"DIC_kwDOLnMFh84Cik-D","reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":true,"css":[null,"/css/custom.css"],"js":[null]},"root":"","source_data":{},"version":"4.2.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arch3rn4r" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
            <a class="site-name border-box" href="/">
               arch3rn4r
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/about">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-user-graduate"></i>
                                
                                关于
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/about">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-user-graduate"></i>
                                </span>
                            
                            关于
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        ble_ctf wp
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/beauty/myhead.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">arch3rn4r</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-04-26 17:53:57</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Fri May 02 2025 11:03:09 GMT+0800">2025-05-02 11:03:09</span>
            </span>
        

        

        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>20.5k 字</span>
            </span>
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="0x0-前期配置"><a href="#0x0-前期配置" class="headerlink" title="0x0 前期配置"></a>0x0 前期配置</h2><p>所需设备：蓝牙适配器，刷入了blectf的esp32,能进行蓝牙操作的设备（kali或者Ubuntu）<br><strong>将blectf靶场刷入esp32</strong><br>安装<a class="link"   target="_blank" rel="noopener" href="https://github.com/espressif/esptool" >esptool<i class="fas fa-external-link-alt"></i></a>(如果出现报错那么去查看“安装时报错”那条)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install esptool</span><br></pre></td></tr></table></figure>
<p>克隆仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/hackgnar/ble_ctf</span><br></pre></td></tr></table></figure>
<p>找到当前esp32在linux的端口，一般是&#x2F;dev&#x2F;ttyUSB0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前所有串口设备</span></span><br><span class="line">/dev/tty*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看usb口设备</span></span><br><span class="line">/dev/ttyUSB*</span><br></pre></td></tr></table></figure>
<p>开始烧录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ble_ctf</span><br><span class="line"></span><br><span class="line">esptool -p /dev/ttyUSB0 -b 460800 --before default_reset --after hard_reset --chip esp32  write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/ble_ctf.bin</span><br></pre></td></tr></table></figure>
<p>一切正常没有报错的话那么就搭建完了</p>
<hr>
<p><strong>启动蓝牙</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ hciconfig</span><br><span class="line">                                                                                                        </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ hciconfig</span><br><span class="line">hci0:   Type: Primary  Bus: USB</span><br><span class="line">        BD Address: 84:E0:F4:03:0F:5E  ACL MTU: 310:10  SCO MTU: 64:8</span><br><span class="line">        DOWN RUNNING </span><br><span class="line">        RX bytes:582 acl:0 sco:0 events:30 errors:0</span><br><span class="line">        TX bytes:367 acl:0 sco:0 commands:30 errors:0</span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop]</span><br><span class="line">└─# hciconfig hci0 up</span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop]</span><br><span class="line">└─# exit</span><br><span class="line">                                                                                                        </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo hciconfig hci0 lestates</span><br><span class="line">Supported link layer states:</span><br><span class="line">        YES Non-connectable Advertising State</span><br><span class="line">        YES Scannable Advertising State</span><br><span class="line">        YES Connectable Advertising State</span><br><span class="line">        YES Directed Advertising State</span><br><span class="line">        YES Passive Scanning State</span><br><span class="line">        YES Active Scanning State</span><br><span class="line">        YES Initiating State/Connection State in Central Role</span><br><span class="line">        YES Connection State in the Peripheral Role</span><br><span class="line">        YES Non-connectable Advertising State and Passive Scanning State combination</span><br><span class="line">        YES Scannable Advertising State and Passive Scanning State combination</span><br><span class="line">        YES Connectable Advertising State and Passive Scanning State combination</span><br><span class="line">        YES Directed Advertising State and Passive Scanning State combination</span><br><span class="line">        YES Non-connectable Advertising State and Active Scanning State combination</span><br><span class="line">        YES Scannable Advertising State and Active Scanning State combination</span><br><span class="line">        YES Connectable Advertising State and Active Scanning State combination</span><br><span class="line">        YES Directed Advertising State and Active Scanning State combination</span><br><span class="line">        YES Non-connectable Advertising State and Initiating State combination</span><br><span class="line">        YES Scannable Advertising State and Initiating State combination</span><br><span class="line">        YES Non-connectable Advertising State and Central Role combination</span><br><span class="line">        YES Scannable Advertising State and Central Role combination</span><br><span class="line">        YES Non-connectable Advertising State and Peripheral Role combination</span><br><span class="line">        YES Scannable Advertising State and Peripheral Role combination</span><br><span class="line">        YES Passive Scanning State and Initiating State combination</span><br><span class="line">        YES Active Scanning State and Initiating State combination</span><br><span class="line">        YES Passive Scanning State and Central Role combination</span><br><span class="line">        YES Active Scanning State and Central Role combination</span><br><span class="line">        YES Passive Scanning State and Peripheral Role combination</span><br><span class="line">        YES Active Scanning State and Peripheral Role combination</span><br><span class="line">        YES Initiating State and Central Role combination/Central Role and Central Role combination</span><br><span class="line">                                                                                                        </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo hcitool lescan</span><br><span class="line">LE Scan ...</span><br><span class="line">64:B7:08:61:B9:7E BLECTF</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<p>这里会用到两种工具，gatttool和bleah,kali自带gatttool<br>查看gatttool的help来学会其用法<br>在这些指令里查找我们需要的参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">└─$ gatttool --help-all            </span><br><span class="line">Usage:</span><br><span class="line">  gatttool [OPTION?]</span><br><span class="line"></span><br><span class="line">Help Options:</span><br><span class="line">  -h, --help                                Show help options</span><br><span class="line">  --help-all                                Show all help options</span><br><span class="line">  --help-gatt                               Show all GATT commands</span><br><span class="line">  --help-params                             Show all Primary Services/Characteristics arguments</span><br><span class="line">  --help-char-read-write                    Show all Characteristics Value/Descriptor Read/Write arguments</span><br><span class="line"></span><br><span class="line">GATT commands</span><br><span class="line">  --primary                                 Primary Service Discovery</span><br><span class="line">  --characteristics                         Characteristics Discovery</span><br><span class="line">  --char-read                               Characteristics Value/Descriptor Read</span><br><span class="line">  --char-write                              Characteristics Value Write Without Response (Write Command)</span><br><span class="line">  --char-write-req                          Characteristics Value Write (Write Request)</span><br><span class="line">  --char-desc                               Characteristics Descriptor Discovery</span><br><span class="line">  --listen                                  Listen for notifications and indications</span><br><span class="line"></span><br><span class="line">Primary Services/Characteristics arguments</span><br><span class="line">  -s, --start=0x0001                        Starting handle (optional)</span><br><span class="line">  -e, --end=0xffff                          Ending handle (optional)</span><br><span class="line">  -u, --uuid=0x1801                         UUID16 or UUID128 (optional)</span><br><span class="line"></span><br><span class="line">Characteristics Value/Descriptor Read/Write arguments</span><br><span class="line">  -a, --handle=0x0001                       Read/Write characteristic by handle (required)</span><br><span class="line">  -n, --value=0x0001                        Write characteristic value (required for write operation)</span><br><span class="line"></span><br><span class="line">Application Options:</span><br><span class="line">  -i, --adapter=hciX                        Specify local adapter interface</span><br><span class="line">  -b, --device=MAC                          Specify remote Bluetooth address</span><br><span class="line">  -t, --addr-type=[public | random]         Set LE address type. Default: public</span><br><span class="line">  -m, --mtu=MTU                             Specify the MTU size</span><br><span class="line">  -p, --psm=PSM                             Specify the PSM for GATT/ATT over BR/EDR</span><br><span class="line">  -l, --sec-level=[low | medium | high]     Set security level. Default: low</span><br><span class="line">  -I, --interactive                         Use interactive mode</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>关于这个挑战的<a class="link"   target="_blank" rel="noopener" href="https://github.com/hackgnar/ble_ctf/blob/master/main/gatts_table_creat_demo.c" >源代码<i class="fas fa-external-link-alt"></i></a>在main&#x2F;gatts_table_creat_demo.c文件里<br>服务器通过内部变量(<code>flag_state</code>数组、<code>score</code>计数器)跟踪每个挑战是否完成<br>这是题目们对应的标志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_SERVICE_UUID_TEST                   = <span class="number">0x00FF</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_SCORE                     = <span class="number">0xFF01</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG                      = <span class="number">0xFF02</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_SIMPLE_READ          = <span class="number">0xFF03</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_MD5                  = <span class="number">0xFF04</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_WRITE_ANYTHING       = <span class="number">0xFF05</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_WRITE_ASCII          = <span class="number">0xFF06</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_WRITE_HEX            = <span class="number">0xFF07</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_SIMPLE_WRITE2_READ   = <span class="number">0xFF08</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_SIMPLE_WRITE2        = <span class="number">0xFF09</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_BRUTE_WRITE          = <span class="number">0xFF0a</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_READ_ALOT            = <span class="number">0xFF0b</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_NOTIFICATION         = <span class="number">0xFF0c</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_INDICATE_READ        = <span class="number">0xFF0d</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_INDICATE             = <span class="number">0xFF0e</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_NOTIFICATION_MULTI   = <span class="number">0xFF0f</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_INDICATE_MULTI_READ  = <span class="number">0xFF10</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_INDICATE_MULTI       = <span class="number">0xFF11</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_MAC                  = <span class="number">0xFF12</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_MTU                  = <span class="number">0xFF13</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_WRITE_RESPONSE       = <span class="number">0xFF14</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_HIDDEN_NOTIFY        = <span class="number">0xFF15</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_CRAZY                = <span class="number">0xFF16</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_FLAG_TWITTER              = <span class="number">0xFF17</span>;</span><br></pre></td></tr></table></figure>
<h2 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h2><p>基础验证<br>这里是基本的句柄写入，也可以用来测试当前环境是否可用，输完第一句后esp32会出现一个蓝色的灯代表连接好了<br>并且在这里说一下提交的要求：<br>默认情况下，读取前<strong>20</strong>个字节(如果您使用的是 gatttool，请确保使用 xxd 将其转换为<strong>十六进制</strong>。如果你使用的是 bleah，你可以将其作为字符串值发送)并将其写入句柄<strong>0x002c</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score: 0/20</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;12345678901234567890&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>解析指令<br>这是主要部分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a</span><br></pre></td></tr></table></figure>
<ul>
<li>-b指定目标蓝牙</li>
<li>–char-read 指定要执行的操作</li>
<li>-a 指定句柄<br>后面的部分是对数据的处理，过滤我们所需的信息<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="0x2-查看及提交句柄"><a href="#0x2-查看及提交句柄" class="headerlink" title="0x2 查看及提交句柄"></a>0x2 查看及提交句柄</h2><p>%% 查看 handle 的 ascii 值 0x002e 并将其提交给 flag submision handle 0x002c。如果您使用的是 gatttool，请确保使用 xxd 将其转换为十六进制。如果你使用的是 bleah，你可以将其作为字符串值发送 %%</p>
<p>进行拆解<br>现在需要读取目标蓝牙的0x002e的值</p>
<ul>
<li>指定目标 -b 64:B7:08:61:B9:7E </li>
<li>读取操作  –char-read </li>
<li>指定句柄 -a 0x002e<br>因此指令为：<code>gatttool -b 64:B7:08:61:B9:7E  --char-read  -a 0x002e</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E  --char-read  -a 0x002e</span><br><span class="line">Characteristic value/descriptor: 64 32 30 35 33 30 33 65 30 39 39 63 65 66 66 34 34 38 33 35 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
出现的是原始数据，我们需要对其进行处理<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002e|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">d205303e099ceff44835</span><br></pre></td></tr></table></figure>
读取成功<br>接下来是写操作，需要将得到的值传递给句柄0x002c</li>
<li>指定目标 -b 64:B7:08:61:B9:7E </li>
<li>写操作 ，写操作这里有两种 ，–char-write无响应，–char-write-req有响应，推荐使用–char-writr-req<ul>
<li>–char-write                              Characteristics Value Write Without Response (Write Command)</li>
<li>–char-write-req                          Characteristics Value Write (Write Request)</li>
</ul>
</li>
<li>指定句柄 -a 0x002c  读写操作都是使用-a指定句柄</li>
<li>传入要写入指定句柄的数据 -n d205303e099ceff44835<ul>
<li>题目要求为“请确保使用 xxd 将其转换为十六进制”，因此<code>-n $(echo -n &quot;d205303e099ceff44835&quot;|xxd -ps)</code><br>总的指令就是：<code>gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;d205303e099ceff44835&quot;|xxd -ps)</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;d205303e099ceff44835&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>
成功<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E  --char-read  -a 0x002e</span><br><span class="line">Characteristic value/descriptor: 64 32 30 35 33 30 33 65 30 39 39 63 65 66 66 34 34 38 33 35 </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002e|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">d205303e099ceff44835</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;d205303e099ceff44835&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:2 /20</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h2><p>%% 查看 handle 0x0030 的 ascii 值。按照它告诉你的去做，并将你找到的标志提交给 0x002c %%</p>
<p>按照之前的思路来读取句柄值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0030|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>要求是设备的md5值（MD5 of Device Name）<br>接下来的步骤除了转换md5值就和0x2一样了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo -n &quot;BLECTF&quot; |md5sum</span><br><span class="line">5cd56d74049ae40f442ece036c6f4f06  -     </span><br></pre></td></tr></table></figure>
<p>需要注意的是，这里只需要传入前20个字符，后续的操作也是这样的，只要前20个字符，并且依旧遵循“如果您使用的是 gatttool，请确保使用 xxd 将其转换为十六进制。”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;5cd56d74049ae40f442e&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>
<p>成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0030|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">MD5 of Device Name</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo -n &quot;BLECTF&quot; |md5sum</span><br><span class="line">5cd56d74049ae40f442ece036c6f4f06  -</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;5cd56d74049ae40f442e&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:3 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="0x4-查找指定的句柄"><a href="#0x4-查找指定的句柄" class="headerlink" title="0x4 查找指定的句柄"></a>0x4 查找指定的句柄</h2><p>%% 蓝牙 GATT 服务提供了一些额外的设备属性。尝试查找 Generic Access -&gt; Device Name 的值。 %%</p>
<h3 id="查找值"><a href="#查找值" class="headerlink" title="查找值"></a>查找值</h3><p>在<a class="link"   target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/assigned-numbers/" >官网<i class="fas fa-external-link-alt"></i></a>就可以查到具体的UUID值，ctrl+f搜索Device Name就可以得到0x2A00,使用-u 来指定uuid就可以对Device Name进行读取<br>BLE的属性类型是有限的，有四个大类：</p>
<ul>
<li>Primary Service（首要服务项）</li>
<li>Secondary Service（次要服务项）</li>
<li>Include（包含服务项）</li>
<li>Characteristic（特征值）<br>也可以进行手动排查<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">找出设备提供哪些顶层服务及其范围</span></span><br><span class="line">gatttool -b 64:B7:08:61:B9:7E --primary</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分区查找特征值</span></span><br><span class="line">gatttool -b 64:B7:08:61:B9:7E --characteristics -s 0x0001 -e 0x0007</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">直接查找全部特征值</span></span><br><span class="line">gatttool -b 64:B7:08:61:B9:7E --characteristics  </span><br></pre></td></tr></table></figure>
结果如下<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --primary</span><br><span class="line">[sudo] password for kali: </span><br><span class="line">attr handle = 0x0001, end grp handle = 0x0005 uuid: 00001801-0000-1000-8000-00805f9b34fb</span><br><span class="line">attr handle = 0x0014, end grp handle = 0x001c uuid: 00001800-0000-1000-8000-00805f9b34fb</span><br><span class="line">attr handle = 0x0028, end grp handle = 0xffff uuid: 000000ff-0000-1000-8000-00805f9b34fb</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --characteristics -s 0x0014 -e 0x001c</span><br><span class="line">handle = 0x0015, char properties = 0x02, char value handle = 0x0016, uuid = 00002a00-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle = 0x0017, char properties = 0x02, char value handle = 0x0018, uuid = 00002a01-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle = 0x0019, char properties = 0x02, char value handle = 0x001a, uuid = 00002aa6-0000-1000-8000-00805f9b34fb</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>在另一个窗口开启btmon<br>在btmon日志里得到uuid和句柄，可以看到<code>Value Handle: 0x0016 Value UUID: Device Name (0x2a00)</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">gatttool[117489]: &lt; ACL Data..X flags 0x00 dlen 11  #1573 [hci0] 23271.388417</span><br><span class="line">      ATT: Read By Type Request (0x08) len 6</span><br><span class="line">        Handle range: 0x0014-0x001c</span><br><span class="line">        Attribute type: Characteristic (0x2803)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed... (0x13) plen 5  <span class="comment">#1574 [hci0] 23271.428098</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #1573: len 11 (2 Kb/s)</span><br><span class="line">        Latency: 39 msec (39-39 msec ~39 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27        <span class="comment">#1575 [hci0] 23271.475504</span></span></span><br><span class="line">      ATT: Read By Type Response (0x09) len 22</span><br><span class="line">        Attribute data length: 7</span><br><span class="line">        Attribute data list: 3 entries</span><br><span class="line">        Handle: 0x0015</span><br><span class="line">        Value[5]: 021600002a</span><br><span class="line">            Properties: 0x02</span><br><span class="line">              Read (0x02)</span><br><span class="line">            Value Handle: 0x0016</span><br><span class="line">            Value UUID: Device Name (0x2a00)</span><br><span class="line">        Handle: 0x0017</span><br><span class="line">        Value[5]: 021800012a</span><br><span class="line">            Properties: 0x02</span><br><span class="line">              Read (0x02)</span><br><span class="line">            Value Handle: 0x0018</span><br><span class="line">            Value UUID: Appearance (0x2a01)</span><br><span class="line">        Handle: 0x0019</span><br><span class="line">        Value[5]: 021a00a62a</span><br><span class="line">            Properties: 0x02</span><br><span class="line">              Read (0x02)</span><br><span class="line">            Value Handle: 0x001a</span><br><span class="line">            Value UUID: Central Address Resolution (0x2aa6)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用–characteristics 会有很多输出，这个时候可以对其进行过滤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查找所有特征值</span></span><br><span class="line">gatttool -b 64:B7:08:61:B9:7E --characteristics </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 btmon 并寻找和目标（Device Name)有关的请求和响应</span></span><br><span class="line">sudo btmon | grep -A 5 -B 5 -i &#x27;Device Name&#x27; </span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo btmon | grep -A 5 -B 5 -i &#x27;Device Name&#x27;   </span><br><span class="line">        Handle: 0x0015</span><br><span class="line">        Value[5]: 021600002a</span><br><span class="line">            Properties: 0x02</span><br><span class="line">              Read (0x02)</span><br><span class="line">            Value Handle: 0x0016</span><br><span class="line">            Value UUID: Device Name (0x2a00)</span><br><span class="line">        Handle: 0x0017</span><br><span class="line">        Value[5]: 021800012a</span><br><span class="line">            Properties: 0x02</span><br><span class="line">              Read (0x02)</span><br><span class="line">            Value Handle: 0x0018</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="进行读取"><a href="#进行读取" class="headerlink" title="进行读取"></a>进行读取</h3><p>从句柄来读取<br><code>-a</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0016|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>从uuid来读<br><code>-u</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -u 0x2a00 | awk -F&#x27;value: &#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p ; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>结果如下，可以看到此次读取中-a和-u的结果是不一样的<br>虽然<code>0x2A00</code>对应Device Name，但设备可能将多个特性映射到同一UUID，导致实际访问的特性与预期不符。使用<code>-u</code>参数时，部分蓝牙栈实现可能默认读取固定长度（如20字节），而<code>-a</code>参数直接读取全部数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0016|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">2b00042f7481c7b056c4b410d28f33cf</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -u 0x2a00|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -u 0x2a00 | awk -F&#x27;value: &#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p ; printf &#x27;\n&#x27;</span><br><span class="line">2b00042f7481c7b056c</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -u 0x2a00</span><br><span class="line">handle: 0x0016   value: 32 62 30 30 30 34 32 66 37 34 38 31 63 37 62 30 35 36 63 </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0016</span><br><span class="line">Characteristic value/descriptor: 32 62 30 30 30 34 32 66 37 34 38 31 63 37 62 30 35 36 63 34 62 34 31 30 64 32 38 66 33 33 63 66 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以在此次提交中我们使用-a读取到的值（记住此次提交也是提交前20个字符，使用 xxd 将其转换为十六进制）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;2b00042f7481c7b056c4&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:4 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="0x5交互性验证"><a href="#0x5交互性验证" class="headerlink" title="0x5交互性验证"></a>0x5交互性验证</h2><p>%% 读取句柄 0032 并按照它所说的去做。请注意，它并没有像以前那样告诉你写入标志句柄。找到标志后，请继续将其写入您在过去标志中使用的标志句柄。 %%</p>
<p>读取句柄</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0032|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>在0x002c写入任意值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;123&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>
<p>之后再读取0x003c值就会发生变化，将这个变化的值再填入0x002c就成功了<br>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0032|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write anything here</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;123&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0032|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">3873c0270763568cf7aa</span><br><span class="line">  </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;3873c0270763568cf7aa&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:5 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="0x6-写入ascii值"><a href="#0x6-写入ascii值" class="headerlink" title="0x6 写入ascii值"></a>0x6 写入ascii值</h2><p>%% 按照读取 handle 0x0034 中的说明进行作。请记住，有些工具只写入十六进制值，而其他工具提供写入十六进制或 ASCII 的方法 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>“Write the ascii value “yo” here”<br>要求写入ascii值(yo对应的十六进制是0x79 0x6f)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0034 -n $(echo -n &quot;yo&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>
<p>再次查看0x0034的值会发现它出现了变化，将新的值写入0x002c</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the ascii value &quot;yo&quot; here</span><br><span class="line">   </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0034 -n 796f</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">c55c6314b3db0a6128af</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;c55c6314b3db0a6128af&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:6 /20</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>关于这题，如果想尝试不同的写入方法可以像这样修改0x0034的值<br>只要把0x0034的值改成不是”yo”，它就会显示最初的提示语了“Write the ascii value “yo” he”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">c55c6314b3db0a6128af</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0034 -n 796g</span><br><span class="line">[sudo] password for kali: </span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the ascii value &quot;yo&quot; he</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-gatttool"><a href="#1-gatttool" class="headerlink" title="1.gatttool"></a>1.gatttool</h3><p>使用十六进制直接写入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0034 -n 796f</span><br></pre></td></tr></table></figure>
<p>在线转换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0034 -n $(echo -n &quot;yo&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>
<h3 id="2-bluetoothctl"><a href="#2-bluetoothctl" class="headerlink" title="2.bluetoothctl"></a>2.bluetoothctl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo bluetoothctl</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进行连接</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入操作菜单</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">menu gatt</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前句柄</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">list-attributes</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">若有目标句柄，则选中</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">select-attribute 0x0034</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">尝试写入；新版本的bluetoothctl是可以直接写入的，如果不行那么写入十六进制形式</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">write <span class="string">&quot;yo&quot;</span></span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">write <span class="string">&quot;0x79 0x6f&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>我使用bluetoothctl时找不到句柄0x0034，所以无法使用这种方法进行写入,这是list的结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">list-attributes</span></span><br><span class="line">Primary Service (Handle 0x0001)</span><br><span class="line">        /org/bluez/hci0/dev_64_B7_08_61_B9_7E/service0001</span><br><span class="line">        00001801-0000-1000-8000-00805f9b34fb</span><br><span class="line">        Generic Attribute Profile</span><br><span class="line">        ...</span><br><span class="line">        Characteristic (Handle 0x0033)</span><br><span class="line">        /org/bluez/hci0/dev_64_B7_08_61_B9_7E/service0028/char0033</span><br><span class="line">        0000ff06-0000-1000-8000-00805f9b34fb</span><br><span class="line">        Unknown</span><br><span class="line">Characteristic (Handle 0x0035)</span><br><span class="line">        /org/bluez/hci0/dev_64_B7_08_61_B9_7E/service0028/char0035</span><br><span class="line">        0000ff07-0000-1000-8000-00805f9b34fb</span><br><span class="line">        Unknown</span><br><span class="line">	    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0x0034是一个非标准或 CTF 特定的隐藏句柄，标准发现工具 bluetoothctl 无法看到，但可以直接操作的 gatttool -a 可以访问。</p>
<ul>
<li><strong>gatttool -a 的行为:</strong> <code>gatttool --char-read -a &lt;handle&gt;</code> 和 <code>--char-write-req -a &lt;handle&gt;</code> 直接作用于<strong>任何</strong>你指定的句柄，不管它代表服务、特征声明、特征值还是描述符。只要该句柄存在且具有相应的读&#x2F;写权限，gatttool 就能直接与之交互。</li>
</ul>
<p>进行验证：<br>使用0x4中查找指定值的方法我找到了0x0034</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --characteristics   </span><br><span class="line">...</span><br><span class="line">handle = 0x0033, char properties = 0x0a, char value handle = 0x0034, uuid = 0000ff06-0000-1000-8000-00805f9b34fb</span><br><span class="line">...</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo btmon | grep -A 5 -B 5 -i &#x27;0x0034&#x27;     </span><br><span class="line">[sudo] password for kali: </span><br><span class="line">        Handle: 0x0033</span><br><span class="line">        Value[5]: 0a340006ff</span><br><span class="line">            Properties: 0x0a</span><br><span class="line">              Read (0x02)</span><br><span class="line">              Write (0x08)</span><br><span class="line">            Value Handle: 0x0034</span><br><span class="line">            Value UUID: Unknown (0xff06)</span><br><span class="line">        Handle: 0x0035</span><br><span class="line">        Value[5]: 0a360007ff</span><br><span class="line">            Properties: 0x0a</span><br><span class="line">              Read (0x02)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是一些解释</p>
<ol>
<li><strong>handle &#x3D; 0x0033 (来自 gatttool –characteristics 输出)</strong><ul>
<li><strong>类型:</strong> 这是<strong>特征声明 (Characteristic Declaration)</strong> 的句柄。</li>
<li><strong>作用:</strong> 这个句柄本身代表了“这里有一个特征”的声明。它包含了一些元数据：<ul>
<li>该特征的属性&#x2F;权限 (Properties): 0x0a (根据 btmon 输出，这意味着 Read 0x02 + Write 0x08)。</li>
<li>指向实际存储该特征值的<strong>值句柄 (Value Handle)</strong>: 0x0034。</li>
<li>该特征的 UUID: 0000ff06-… (标识这个特征是什么)。</li>
</ul>
</li>
<li><strong>交互:</strong> 你通常<strong>不直接</strong>读取或写入特征声明句柄 (0x0033) 本身。它的值 (0a340006ff 来自 btmon) 包含了上面提到的元数据，由客户端在发现过程中读取。</li>
</ul>
</li>
<li><strong>char value handle &#x3D; 0x0034 (来自 gatttool –characteristics 输出) &#x2F; Value Handle: 0x0034 (来自 btmon 输出)</strong><ul>
<li><strong>类型:</strong> 这是<strong>特征值 (Characteristic Value)</strong> 的句柄。</li>
<li><strong>作用:</strong> 这个句柄指向<strong>实际存储数据的地方</strong>。当你想要读取这个特征当前的值，或者想要向这个特征写入新值时，你<strong>必须使用这个句柄</strong>。</li>
<li><strong>交互:</strong><ul>
<li>要<strong>读取</strong>这个特征的值，你应该执行 gatttool … –char-read -a 0x0034。</li>
<li>要<strong>写入</strong>这个特征的值（因为它具有 Write 属性 0x08），你应该执行 gatttool … –char-write-req -a 0x0034 -n <hex_data> 或 gatttool … –char-write -a 0x0034 -n <hex_data>。</li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li><strong>0x0033 是特征声明句柄 (Characteristic Declaration Handle):</strong> 它是一个元数据条目，描述了特征的存在、属性（权限）、值句柄和 UUID。它的值包含了这些结构化的信息，通常不由客户端直接写入来改变用户数据。</li>
<li><strong>0x0034 是特征值句柄 (Characteristic Value Handle):</strong> 这才是<strong>实际存储该特征数据的地方</strong>。所有针对该特征的读写操作都应该<strong>直接作用于这个句柄</strong>。</li>
</ul>
<p>所以如果要使用bluetoothctl来修改句柄0x0034的值，需要指定对象路径<code>/org/bluez/hci0/dev_64_B7_08_61_B9_7E/service0028/char0033</code>而不是0x0033<br>但我尝试了下，还是无法写入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">select-attribute /org/bluez/hci0/dev_64_B7_08_61_B9_7E/service0028/char0033</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">write <span class="string">&quot;0x79 0x6f&quot;</span></span></span><br><span class="line">No attribute selected</span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">select-attribute 0000ff06-0000-1000-8000-00805f9b34fb</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">write <span class="string">&quot;0x79 0x6f&quot;</span></span></span><br><span class="line">No attribute selected</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-脚本"><a href="#3-脚本" class="headerlink" title="3.脚本"></a>3.脚本</h3><p>bluepy 通常需要 root 权限来访问底层的蓝牙接口和 bluepy-helper 程序。<br>不需要额外的进行<code>pip install bluepy</code>,当你尝试这样做时反而会报错<br>不建议使用bleak来做这题，理由和bluetoothctl一样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bluepy <span class="keyword">import</span> btle</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置参数 ---</span></span><br><span class="line">DEVICE_ADDRESS = <span class="string">&quot;64:B7:08:61:B9:7E&quot;</span>  <span class="comment"># 替换为你的目标设备 MAC 地址</span></span><br><span class="line"><span class="comment"># 地址类型：通常是公共地址。如果是随机地址，使用 btle.ADDR_TYPE_RANDOM</span></span><br><span class="line">ADDR_TYPE = btle.ADDR_TYPE_PUBLIC</span><br><span class="line">TARGET_HANDLE = <span class="number">0x0034</span>              <span class="comment"># 你要写入数据的目标句柄</span></span><br><span class="line">DATA_TO_WRITE = <span class="string">b&quot;yo&quot;</span>               <span class="comment"># 要写入的 ASCII 值 &quot;yo&quot;，表示为字节串 (bytes)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在连接到 <span class="subst">&#123;DEVICE_ADDRESS&#125;</span>...&quot;</span>)</span><br><span class="line">conn = <span class="literal">None</span>  <span class="comment"># 初始化连接对象为 None，以便在 finally 中检查</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 创建连接对象并连接</span></span><br><span class="line">    conn = btle.Peripheral(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;连接成功!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在向句柄 <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span> 写入 <span class="subst">&#123;DATA_TO_WRITE!r&#125;</span>...&quot;</span>)</span><br><span class="line">    <span class="comment"># 执行写入操作</span></span><br><span class="line">    <span class="comment"># 第一个参数是目标句柄</span></span><br><span class="line">    <span class="comment"># 第二个参数是要写入的数据（必须是 bytes 类型）</span></span><br><span class="line">    <span class="comment"># withResponse=True 表示执行 Write Request (需要响应)，类似 gatttool --char-write-req</span></span><br><span class="line">    <span class="comment"># 如果需要 Write Command (无响应)，则设置 withResponse=False</span></span><br><span class="line">    conn.writeCharacteristic(TARGET_HANDLE, DATA_TO_WRITE, withResponse=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;写入成功!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> btle.BTLEDisconnectError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 捕获断开连接错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;连接已断开: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 捕获其他 bluepy 相关的蓝牙错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;蓝牙错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 捕获其他任何意外错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发生意外错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 无论成功还是失败，最后都尝试断开连接</span></span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在断开连接...&quot;</span>)</span><br><span class="line">            conn.disconnect()</span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">             <span class="comment"># 如果连接已因错误断开，再次断开可能会抛出异常，此处捕获</span></span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f&quot;断开连接时发生错误（可能已断开）: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo python ble1.py                                            </span><br><span class="line">正在连接到 64:B7:08:61:B9:7E...</span><br><span class="line">连接成功!</span><br><span class="line">正在向句柄 0x34 写入 b&#x27;yo&#x27;...</span><br><span class="line">写入成功!</span><br><span class="line">正在断开连接...     </span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">c55c6314b3db0a6128af</span><br><span class="line"></span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="0x7-写入hex值"><a href="#0x7-写入hex值" class="headerlink" title="0x7 写入hex值"></a>0x7 写入hex值</h2><p>%% 按照读取 handle 0x0036 中的说明进行操作。请记住，有些工具只写入十六进制值，而其他工具提供写入十六进制或 ASCII 的方法 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>要求写入hex值：Write the hex value 0x07 here<br>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the hex value 0x07 here</span><br><span class="line"> </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0036 -n 7</span><br><span class="line">Invalid value</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0036 -n 07</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">1179080b29f8da16ad66</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;1179080b29f8da16ad66&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:7 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-gatttool-1"><a href="#1-gatttool-1" class="headerlink" title="1.gatttool"></a>1.gatttool</h3><p>gatttool 的 -n 参数期望一个十六进制<strong>字符串</strong>。对于单个字节 0x07，其十六进制字符串表示就是 07。（注意是07不是7）<br>gatttool 的 -n 参数期望接收的是一个有效的十六进制字符串，而不仅仅是一个数字字符</p>
<ul>
<li>在十六进制中，有效的字符是 0-9 和 a-f (或 A-F)。单个字符 7 是一个有效的十六进制数字，代表数值 7。</li>
<li><strong>但是，</strong> gatttool（以及底层的蓝牙协议）通常期望十六进制数据是<strong>成对出现的</strong>，因为一个字节通常用<strong>两个</strong>十六进制字符表示（例如，00 到 ff）。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0036 -n 7</span><br><span class="line">Invalid value</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0036 -n 07</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">1179080b29f8da16ad66</span><br><span class="line"></span><br></pre></td></tr></table></figure>
其他形式能够写入，但是判定不正确<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0036 -n 0x07</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the hex value 0x07 here</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-脚本"><a href="#2-脚本" class="headerlink" title="2.脚本"></a>2.脚本</h3><p>使用bluepy</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bluepy <span class="keyword">import</span> btle</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置参数 ---</span></span><br><span class="line">DEVICE_ADDRESS = <span class="string">&quot;64:B7:08:61:B9:7E&quot;</span>  <span class="comment"># 替换为你的 MAC 地址</span></span><br><span class="line">ADDR_TYPE = btle.ADDR_TYPE_PUBLIC</span><br><span class="line">TARGET_HANDLE = <span class="number">0x0036</span>              <span class="comment"># 目标句柄</span></span><br><span class="line">HEX_VALUE_TO_WRITE = <span class="number">0x07</span>           <span class="comment"># 要写入的十六进制值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将十六进制值转换为 bytes 对象</span></span><br><span class="line">data_to_write = <span class="built_in">bytes</span>([HEX_VALUE_TO_WRITE]) <span class="comment"># -&gt; b&#x27;\x07&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在连接到 <span class="subst">&#123;DEVICE_ADDRESS&#125;</span>...&quot;</span>)</span><br><span class="line">conn = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = btle.Peripheral(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;连接成功!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在向句柄 <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span> 写入 <span class="subst">&#123;data_to_write!r&#125;</span>...&quot;</span>)</span><br><span class="line">    <span class="comment"># 执行写入操作, withResponse=True 表示 Write Request</span></span><br><span class="line">    conn.writeCharacteristic(TARGET_HANDLE, data_to_write, withResponse=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;写入成功!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> btle.BTLEDisconnectError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;连接已断开: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;蓝牙错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发生意外错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在断开连接...&quot;</span>)</span><br><span class="line">            conn.disconnect()</span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f&quot;断开连接时发生错误（可能已断开）: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>记得使用sudo来执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ python ble2.py                                                 </span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/home/kali/Desktop/ble2.py&quot;, line 3, in &lt;module&gt;</span><br><span class="line">    from bluepy import btle</span><br><span class="line">ModuleNotFoundError: No module named &#x27;bluepy&#x27;</span><br><span class="line"></span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the hex value 0x07 here</span><br><span class="line"></span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo python ble2.py                                                  </span><br><span class="line">[sudo] password for kali: </span><br><span class="line">正在连接到 64:B7:08:61:B9:7E...</span><br><span class="line">连接成功!</span><br><span class="line">正在向句柄 0x36 写入 b&#x27;\x07&#x27;...</span><br><span class="line">写入成功!</span><br><span class="line">正在断开连接...</span><br><span class="line"></span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">1179080b29f8da16ad66</span><br><span class="line">   </span><br></pre></td></tr></table></figure>


<h2 id="0x8-指定句柄的方式"><a href="#0x8-指定句柄的方式" class="headerlink" title="0x8 指定句柄的方式"></a>0x8 指定句柄的方式</h2><p>%% 按照读取 handle 0x0038 中的说明进行作。请注意此处的句柄。请记住，句柄可以由整数或十六进制引用。大多数工具（如 gatttool 和 bleah）都允许您以两种方式指定句柄。 %%</p>
<p>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0038|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Write 0xC9 to handle 58<br>也就是说将十六进制数0xc9写入句柄58就可以了，58的十六进制是0x3A</p>
<p>-a后面可以接十进制也可以接十六进制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0038 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Write 0xC9 to handle 58</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 58 -n &quot;$(printf &quot;\xc&quot; | xxd -ps)&quot;</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0038|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">f8b136d937fad6a2be9f</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;f8b136d937fad6a2be9f&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:8 /20</span><br></pre></td></tr></table></figure>

<h2 id="0x9-多次写"><a href="#0x9-多次写" class="headerlink" title="0x9 多次写"></a>0x9 多次写</h2><p>%% 看看 handle 0x003c 并按照它所说的去做。您应该为此编写一个解决方案。另请记住，某些工具的写入速度比其他工具快。 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x003c | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Brute force my value 00 to ff<br>爆破句柄0x003c的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> bluepy <span class="keyword">import</span> btle</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置 ---</span></span><br><span class="line">DEVICE_ADDRESS = <span class="string">&quot;64:B7:08:61:B9:7E&quot;</span>      <span class="comment"># 目标设备 MAC 地址</span></span><br><span class="line">ADDR_TYPE = btle.ADDR_TYPE_PUBLIC       <span class="comment"># 地址类型</span></span><br><span class="line">TARGET_HANDLE = <span class="number">0x003c</span>                  <span class="comment"># 要写入和检查的句柄 (十六进制)</span></span><br><span class="line">INITIAL_VALUE = <span class="string">b&quot;Brute force my value 00 to ff&quot;</span> <span class="comment"># 句柄的初始值 (bytes 类型)</span></span><br><span class="line">SLEEP_INTERVAL = <span class="number">0.05</span>                   <span class="comment"># 每次写入后的暂停时间（秒），可调整</span></span><br><span class="line">RECONNECT_DELAY = <span class="number">2</span>                     <span class="comment"># 尝试重连前的等待时间（秒）</span></span><br><span class="line">WRITE_TIMEOUT_DEFAULT = <span class="number">1.0</span>             <span class="comment"># 默认写入超时（bluepy内部使用）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Target: <span class="subst">&#123;DEVICE_ADDRESS&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Target Handle: <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Initial Expected Value: <span class="subst">&#123;INITIAL_VALUE!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">conn = <span class="literal">None</span>         <span class="comment"># 初始化连接对象</span></span><br><span class="line">found_value = <span class="literal">None</span>  <span class="comment"># 用于存储找到的正确值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connecting...&quot;</span>)</span><br><span class="line">    conn = btle.Peripheral(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">    <span class="comment"># conn.setSecurityLevel(&quot;medium&quot;) # 如果需要配对，可能需要设置安全级别</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 主循环：暴力破解 0x00 到 0xFF ---</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>): <span class="comment"># 0 到 255</span></span><br><span class="line">        value_to_try = i</span><br><span class="line">        hex_value_str = <span class="string">f&quot;<span class="subst">&#123;value_to_try:02x&#125;</span>&quot;</span>      <span class="comment"># 用于打印的十六进制字符串</span></span><br><span class="line">        data_byte = <span class="built_in">bytes</span>([value_to_try])        <span class="comment"># 要写入的单字节 bytes 对象</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Trying value: <span class="subst">&#123;<span class="built_in">hex</span>(value_to_try)&#125;</span> (Hex: <span class="subst">&#123;hex_value_str&#125;</span>, Bytes: <span class="subst">&#123;data_byte!r&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- 执行写入 ---</span></span><br><span class="line">            <span class="comment"># 使用 withResponse=True 尝试 Write Request</span></span><br><span class="line">            conn.writeCharacteristic(TARGET_HANDLE, data_byte, withResponse=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># print(&quot;  Write request sent successfully (protocol level).&quot;) # 可以取消注释用于调试</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 成功检查：读取同一个句柄的值 ---</span></span><br><span class="line">            <span class="comment"># 等待一小段时间让设备处理</span></span><br><span class="line">            time.sleep(SLEEP_INTERVAL)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 读取当前句柄的值</span></span><br><span class="line">            current_value = conn.readCharacteristic(TARGET_HANDLE)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  -&gt; Value read back from <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span>: <span class="subst">&#123;current_value!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查值是否已经改变 (不再是初始值)</span></span><br><span class="line">            <span class="keyword">if</span> current_value != INITIAL_VALUE:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;!!! SUCCESS: Handle <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span> value changed!           !!!&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;!!! Correct value likely: <span class="subst">&#123;<span class="built_in">hex</span>(value_to_try)&#125;</span> (Hex: <span class="subst">&#123;hex_value_str&#125;</span>)        !!!&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;!!! New value in handle: <span class="subst">&#123;current_value!r&#125;</span> !!!&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n&quot;</span>)</span><br><span class="line">                found_value = value_to_try</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># 找到正确值，退出循环</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># --- 处理写入或读取错误 ---</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  -&gt; FAILED for value <span class="subst">&#123;<span class="built_in">hex</span>(value_to_try)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查是否是连接丢失错误</span></span><br><span class="line">            connection_lost = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 尝试发送一个无操作的请求（如读取RSSI）来检查连接状态</span></span><br><span class="line">                conn.getrssi()</span><br><span class="line">            <span class="keyword">except</span> btle.BTLEDisconnectError:</span><br><span class="line">                connection_lost = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> btle.BTLEException:</span><br><span class="line">                <span class="comment"># 其他蓝牙错误也可能意味着连接问题</span></span><br><span class="line">                connection_lost = <span class="literal">True</span> <span class="comment"># 保守假设连接可能丢失</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> connection_lost:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Connection lost, attempting to reconnect...&quot;</span>)</span><br><span class="line">                time.sleep(RECONNECT_DELAY)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    conn.connect(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Reconnected successfully.&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> recon_e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;Reconnect failed: <span class="subst">&#123;recon_e&#125;</span>. Aborting.&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span> <span class="comment"># 重连失败，放弃</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果不是连接丢失错误，可能是写入不允许或其他错误，继续下一个尝试</span></span><br><span class="line">                <span class="comment"># print(&quot;  Continuing to next value...&quot;)</span></span><br><span class="line">                <span class="comment"># 短暂暂停避免过于频繁的无效尝试</span></span><br><span class="line">                time.sleep(SLEEP_INTERVAL * <span class="number">2</span>) <span class="comment"># 错误后暂停时间稍长</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 防止循环过快占用过多 CPU</span></span><br><span class="line">        time.sleep(SLEEP_INTERVAL)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> btle.BTLEDisconnectError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nError: Disconnected during operation: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nError: Bluetooth operation failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nOperation cancelled by user.&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nAn unexpected error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># --- 清理：确保断开连接 ---</span></span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Disconnecting...&quot;</span>)</span><br><span class="line">            conn.disconnect()</span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException:</span><br><span class="line">            <span class="comment"># 可能已经断开连接，忽略错误</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 结果报告 ---</span></span><br><span class="line"><span class="keyword">if</span> found_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nBrute force finished. The correct value appears to be: <span class="subst">&#123;<span class="built_in">hex</span>(found_value)&#125;</span> (Decimal: <span class="subst">&#123;found_value&#125;</span>)&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>) <span class="comment"># 成功退出</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nBrute force finished. The correct value was not found (or the handle value did not change).&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>) <span class="comment"># 失败退出</span></span><br></pre></td></tr></table></figure>
<p>输出为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Trying value: 0xd0 (Hex: d0, Bytes: b&#x27;\xd0&#x27;)</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">Value <span class="built_in">read</span> back from 0x3c: b<span class="string">&#x27;Brute force my value 00 to ff&#x27;</span></span></span><br><span class="line">Trying value: 0xd1 (Hex: d1, Bytes: b&#x27;\xd1&#x27;)</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">Value <span class="built_in">read</span> back from 0x3c: b<span class="string">&#x27;933c1fcfa8ed52d2ec05&#x27;</span></span></span><br><span class="line"></span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!! SUCCESS: Handle 0x3c value changed!           !!!</span><br><span class="line">!!! Correct value likely: 0xd1 (Hex: d1)        !!!</span><br><span class="line">!!! New value in handle: b&#x27;933c1fcfa8ed52d2ec05&#x27; !!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line"></span><br><span class="line">Disconnecting...</span><br><span class="line"></span><br><span class="line">Brute force finished. The correct value appears to be: 0xd1 (Decimal: 209)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进行验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;933c1fcfa8ed52d2ec05&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:9 /20</span><br></pre></td></tr></table></figure>


<h2 id="0x10-多次读"><a href="#0x10-多次读" class="headerlink" title="0x10 多次读"></a>0x10 多次读</h2><p>%% 看看 Handle 0x003e 并按照它所说的去做。请记住，某些工具在执行读取和写入时比其他工具具有更好的连接速度。这与该工具提供的功能或它如何在主机 OS 上使用缓存的 BT 连接有关。尝试针对此标志测试不同的工具。找到最快的一个后，启动脚本或 bash 1 liner 以完成任务。仅供参考，一旦运行，如果作得当，此任务大约需要 90 秒才能完成。 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x003e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Read me 1000 times<br>读取0x003e一千次</p>
<h3 id="执行一千次shell操作"><a href="#执行一千次shell操作" class="headerlink" title="执行一千次shell操作"></a>执行一千次shell操作</h3><p>执行一千次shell操作并打印最后十次的结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x003e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>设定时间为三分钟，一旦出现报错就立即停止</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--- 配置 ---</span></span><br><span class="line">MAC=&quot;64:B7:08:61:B9:7E&quot;</span><br><span class="line">HANDLE=&quot;0x003e&quot;</span><br><span class="line">COUNT=1000</span><br><span class="line">LAST_N=10 # 只打印最后 N 次的结果</span><br><span class="line">READ_TIMEOUT=5 # gatttool 读取超时（秒）</span><br><span class="line">MAX_DURATION_SECONDS=180 # 最大总执行时间（秒），3分钟</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--- 用于存储最后 N 个结果的数组 ---</span></span><br><span class="line">declare -a last_results</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--- 开始时间和计数器 ---</span></span><br><span class="line">start_time=$(date +%s)</span><br><span class="line">completed_reads=0</span><br><span class="line">error_occurred=false</span><br><span class="line"></span><br><span class="line">echo &quot;Starting to read handle $HANDLE from $MAC, $COUNT times...&quot;</span><br><span class="line">echo &quot;(Using gatttool in a loop - this will be VERY SLOW and potentially unstable)&quot;</span><br><span class="line">echo &quot;Max duration set to $MAX_DURATION_SECONDS seconds.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--- 主循环 ---</span></span><br><span class="line">for (( i=1; i&lt;=COUNT; i++ )); do</span><br><span class="line">    # --- 检查总执行时间 ---</span><br><span class="line">    current_time=$(date +%s)</span><br><span class="line">    elapsed_time=$((current_time - start_time))</span><br><span class="line">    if [ &quot;$elapsed_time&quot; -gt &quot;$MAX_DURATION_SECONDS&quot; ]; then</span><br><span class="line">        echo -e &quot;\nError: Execution time exceeded $&#123;MAX_DURATION_SECONDS&#125; seconds. Stopping.&quot;</span><br><span class="line">        error_occurred=true</span><br><span class="line">        break # 超时则跳出循环</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 打印进度 (每 10 次打印一次)</span><br><span class="line">    if (( i % 10 == 0 )) || [ &quot;$i&quot; -eq &quot;$COUNT&quot; ]; then</span><br><span class="line">       printf &quot;\rReading %d/%d (Elapsed: %ds)...&quot; &quot;$i&quot; &quot;$COUNT&quot; &quot;$elapsed_time&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # --- 执行命令并捕获输出 ---</span><br><span class="line">    # 捕获标准输出，错误输出丢弃（或重定向到日志文件）</span><br><span class="line">    output=$(gatttool -b &quot;$MAC&quot; --char-read -a &quot;$HANDLE&quot; -t &quot;$READ_TIMEOUT&quot; 2&gt;/dev/null | awk -F&#x27;: &#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p)</span><br><span class="line">    exit_code=$? # 获取管道中最后一个命令(xxd)的退出码？这不一定可靠，最好检查gatttool本身</span><br><span class="line"></span><br><span class="line">    # 更可靠地检查 gatttool 是否成功连接并读取</span><br><span class="line">    # 运行 gatttool 并检查其退出码，忽略解码管道的退出码</span><br><span class="line">    gatttool_output=$(gatttool -b &quot;$MAC&quot; --char-read -a &quot;$HANDLE&quot; -t &quot;$READ_TIMEOUT&quot; 2&gt;&amp;1)</span><br><span class="line">    gatttool_exit_code=$?</span><br><span class="line"></span><br><span class="line">    if [ $gatttool_exit_code -ne 0 ]; then</span><br><span class="line">        # 如果 gatttool 命令本身失败</span><br><span class="line">        echo -e &quot;\nError: gatttool failed on read #$i (Exit code: $gatttool_exit_code). Stopping.&quot;</span><br><span class="line">        echo &quot;       gatttool output: $gatttool_output&quot;</span><br><span class="line">        error_occurred=true</span><br><span class="line">        break # 遇到错误停止</span><br><span class="line">    else</span><br><span class="line">        # gatttool 成功，解码输出</span><br><span class="line">        decoded_output=$(echo &quot;$gatttool_output&quot; | awk -F&#x27;: &#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p)</span><br><span class="line"></span><br><span class="line">        # --- 存储结果 ---</span><br><span class="line">        # 将结果添加到数组末尾</span><br><span class="line">        last_results+=(&quot;$decoded_output&quot;)</span><br><span class="line">        # 如果数组超长，移除第一个元素</span><br><span class="line">        if [ $&#123;#last_results[@]&#125; -gt $LAST_N ]; then</span><br><span class="line">            last_results=(&quot;$&#123;last_results[@]:1&#125;&quot;) # Bash 4+ 语法移除第一个元素</span><br><span class="line">        fi</span><br><span class="line">        completed_reads=$i</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # (可选) 短暂暂停</span><br><span class="line">    # sleep 0.01</span><br><span class="line"></span><br><span class="line">    # 添加 Ctrl+C 中断处理</span><br><span class="line">    trap &quot;echo -e &#x27;\nRead sequence interrupted by user.&#x27;; exit 1&quot; INT</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo # 结束进度条打印，换行</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--- 打印最终结果 ---</span></span><br><span class="line">current_time=$(date +%s)</span><br><span class="line">elapsed_time=$((current_time - start_time))</span><br><span class="line">echo &quot;-----------------------------------------&quot;</span><br><span class="line">echo &quot;Finished.&quot;</span><br><span class="line">echo &quot;Total execution time: $&#123;elapsed_time&#125; seconds.&quot;</span><br><span class="line">echo &quot;Completed reads: $&#123;completed_reads&#125;/$&#123;COUNT&#125;.&quot;</span><br><span class="line"></span><br><span class="line">if [ &quot;$error_occurred&quot; = true ]; then</span><br><span class="line">    echo &quot;Operation stopped due to error or timeout.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">elif [ &quot;$completed_reads&quot; -lt &quot;$COUNT&quot; ]; then</span><br><span class="line">     echo &quot;Operation stopped before completing all reads (likely interrupted).&quot;</span><br><span class="line">     exit 1</span><br><span class="line">else</span><br><span class="line">    echo &quot;Operation completed $COUNT reads.&quot;</span><br><span class="line">    echo &quot;\nLast $LAST_N read values:&quot;</span><br><span class="line">    # 打印存储的最后 N 个结果</span><br><span class="line">    count_to_print=$&#123;#last_results[@]&#125; # 获取实际存储的数量</span><br><span class="line">    if [ $count_to_print -gt 0 ]; then</span><br><span class="line">        start_print_index=$((COUNT - count_to_print + 1))</span><br><span class="line">         # 使用 printf 格式化输出</span><br><span class="line">        for k in &quot;$&#123;!last_results[@]&#125;&quot;; do # 遍历数组索引</span><br><span class="line">            original_index=$((start_print_index + k))</span><br><span class="line">            printf &quot;  Read #%d: %s\n&quot; &quot;$original_index&quot; &quot;$&#123;last_results[$k]&#125;&quot;</span><br><span class="line">        done</span><br><span class="line">    else</span><br><span class="line">        echo &quot;  No results were successfully stored.&quot;</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;-----------------------------------------&quot;</span><br><span class="line">    exit 0 # 成功退出</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>成功，但是用了更多的多的时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ ./test4.sh</span><br><span class="line">Starting to read handle 0x003e from 64:B7:08:61:B9:7E, 1000 times...</span><br><span class="line">(Using gatttool in a loop - this will be VERY SLOW and potentially unstable)</span><br><span class="line">Max duration set to 180 seconds.</span><br><span class="line">Reading 1000/1000 (Elapsed: 161s)...</span><br><span class="line">-----------------------------------------</span><br><span class="line">Finished.</span><br><span class="line">Total execution time: 161 seconds.</span><br><span class="line">Completed reads: 1000/1000.</span><br><span class="line">Operation completed 1000 reads.</span><br><span class="line">\nLast 10 read values:</span><br><span class="line">  Read #991: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #992: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #993: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #994: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #995: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #996: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #997: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #998: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #999: 6ffcd214ffebdc0d069e</span><br><span class="line">  Read #1000: 6ffcd214ffebdc0d069e</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进行验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x002c -n $(echo -n &quot;6ffcd214ffebdc0d069e&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:10 /20</span><br></pre></td></tr></table></figure>

<h3 id="bluepy"><a href="#bluepy" class="headerlink" title="bluepy"></a>bluepy</h3><p>使用bluepy会更快</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> bluepy <span class="keyword">import</span> btle</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置 ---</span></span><br><span class="line">DEVICE_ADDRESS = <span class="string">&quot;64:B7:08:61:B9:7E&quot;</span>      <span class="comment"># 目标设备 MAC 地址</span></span><br><span class="line">ADDR_TYPE = btle.ADDR_TYPE_PUBLIC       <span class="comment"># 地址类型</span></span><br><span class="line">TARGET_HANDLE = <span class="number">0x003e</span>                  <span class="comment"># 要重复读取的句柄</span></span><br><span class="line">READ_COUNT = <span class="number">1000</span>                       <span class="comment"># 要读取的次数</span></span><br><span class="line">LAST_N_RESULTS = <span class="number">10</span>                    <span class="comment"># 存储并打印最后多少个结果</span></span><br><span class="line">MAX_DURATION_SECONDS = <span class="number">180</span>              <span class="comment"># 最大执行时间（秒），3分钟</span></span><br><span class="line">RECONNECT_DELAY = <span class="number">2</span>                     <span class="comment"># 尝试重连前的等待时间（秒）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 用于存储和检测变化的变量 ---</span></span><br><span class="line">results = []                <span class="comment"># 存储最后 N 个结果</span></span><br><span class="line">previous_value = <span class="literal">None</span>       <span class="comment"># 存储上一次读取的值</span></span><br><span class="line">change_detected_at = <span class="literal">None</span>   <span class="comment"># 记录第一次发生变化的读取次数</span></span><br><span class="line">value_after_change = <span class="literal">None</span>   <span class="comment"># 记录变化后的第一个值</span></span><br><span class="line">operation_successful = <span class="literal">False</span> <span class="comment"># 标记操作是否未出错完成</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Target: <span class="subst">&#123;DEVICE_ADDRESS&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Handle to read repeatedly: <span class="subst">&#123;<span class="built_in">hex</span>(TARGET_HANDLE)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Number of reads required: <span class="subst">&#123;READ_COUNT&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Maximum execution time: <span class="subst">&#123;MAX_DURATION_SECONDS&#125;</span> seconds&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Will store and print last <span class="subst">&#123;LAST_N_RESULTS&#125;</span> results.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Will report first detected value change.&quot;</span>)</span><br><span class="line"></span><br><span class="line">conn = <span class="literal">None</span></span><br><span class="line">start_time = datetime.now() <span class="comment"># 记录开始时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connecting...&quot;</span>)</span><br><span class="line">    conn = btle.Peripheral(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 重复读取循环 ---</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, READ_COUNT + <span class="number">1</span>):</span><br><span class="line">        current_time = datetime.now()</span><br><span class="line">        elapsed_seconds = <span class="built_in">int</span>((current_time - start_time).total_seconds()) <span class="comment"># 计算已用时间（整数秒）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 打印进度和已用时间 ---</span></span><br><span class="line">        <span class="comment"># 使用 \r 实现行内更新，flush=True 确保立即显示</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\rReading <span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;READ_COUNT&#125;</span> (Elapsed: <span class="subst">&#123;elapsed_seconds&#125;</span>s)...&quot;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 检查总执行时间 ---</span></span><br><span class="line">        <span class="keyword">if</span> elapsed_seconds &gt; MAX_DURATION_SECONDS:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\nError: Execution time exceeded <span class="subst">&#123;MAX_DURATION_SECONDS&#125;</span> seconds. Stopping.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span> <span class="comment"># 超时则跳出循环</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- 执行读取操作 ---</span></span><br><span class="line">            current_value = conn.readCharacteristic(TARGET_HANDLE)</span><br><span class="line">            results.append(current_value) <span class="comment"># 添加到结果列表</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保持结果列表最多为 LAST_N_RESULTS 个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt; LAST_N_RESULTS:</span><br><span class="line">                results.pop(<span class="number">0</span>) <span class="comment"># 移除最早的一个</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 检测值是否改变 (仅在第一次改变时记录) ---</span></span><br><span class="line">            <span class="keyword">if</span> previous_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> current_value != previous_value <span class="keyword">and</span> change_detected_at <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                change_detected_at = i</span><br><span class="line">                value_after_change = current_value</span><br><span class="line">                <span class="comment"># 发现变化时立即打印信息，并换行以保留进度条的最后状态</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n*** Value change detected at read #<span class="subst">&#123;i&#125;</span>! ***&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    Previous value (read #<span class="subst">&#123;i-<span class="number">1</span>&#125;</span>): <span class="subst">&#123;previous_value!r&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    New value (read #<span class="subst">&#123;i&#125;</span>):      <span class="subst">&#123;value_after_change!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新上一个值，用于下一次比较</span></span><br><span class="line">            previous_value = current_value</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># --- 处理读取错误 ---</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\nError during read #<span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            connection_lost = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                conn.getState()</span><br><span class="line">                <span class="keyword">if</span> conn.getState() != <span class="string">&quot;conn&quot;</span>: connection_lost = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception: connection_lost = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> connection_lost:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Connection lost. Aborting script.&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;An error occurred, but connection seems stable. Aborting script.&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f&quot;\nAn unexpected non-Bluetooth error occurred during read #<span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">             <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可以在这里加入非常小的暂停，如果需要的话</span></span><br><span class="line">        <span class="comment"># time.sleep(0.01)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># for 循环正常结束 (没有 break)</span></span><br><span class="line">        <span class="built_in">print</span>() <span class="comment"># 结束进度打印，换行</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt;= READ_COUNT % LAST_N_RESULTS <span class="keyword">or</span> READ_COUNT &lt;= LAST_N_RESULTS : <span class="comment"># 检查是否真的完成了所有读取</span></span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f&quot;\nSuccessfully completed <span class="subst">&#123;READ_COUNT&#125;</span> reads.&quot;</span>)</span><br><span class="line">             operation_successful = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> btle.BTLEDisconnectError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nError: Disconnected during operation: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nError: Bluetooth connection or operation failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nOperation cancelled by user.&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nAn unexpected error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># --- 清理：确保断开连接 ---</span></span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Disconnecting...&quot;</span>)</span><br><span class="line">            conn.disconnect()</span><br><span class="line">        <span class="keyword">except</span> btle.BTLEException:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 最终报告 ---</span></span><br><span class="line">    end_time = datetime.now()</span><br><span class="line">    duration = end_time - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nTotal execution time: <span class="subst">&#123;duration&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 报告变化检测结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">if</span> change_detected_at <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Value change detected at read number: <span class="subst">&#123;change_detected_at&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Value after change was: <span class="subst">&#123;value_after_change!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No value change detected during the reads.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> operation_successful:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Operation finished within time limit and without critical errors.&quot;</span>)</span><br><span class="line">        <span class="comment"># 打印最后 N 个结果</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nLast <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> read values (up to <span class="subst">&#123;LAST_N_RESULTS&#125;</span>):&quot;</span>)</span><br><span class="line">        start_print_index = <span class="built_in">max</span>(<span class="number">1</span>, READ_COUNT - <span class="built_in">len</span>(results) + <span class="number">1</span>) <span class="comment"># 计算起始索引</span></span><br><span class="line">        <span class="keyword">for</span> k, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):</span><br><span class="line">            original_index = start_print_index + k</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Read #<span class="subst">&#123;original_index&#125;</span>: <span class="subst">&#123;val.<span class="built_in">hex</span>()&#125;</span> (<span class="subst">&#123;val!r&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>) <span class="comment"># 成功退出</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Operation did not complete successfully or timed out.&quot;</span>)</span><br><span class="line">        <span class="comment"># 如果有部分结果，也打印出来</span></span><br><span class="line">        <span class="keyword">if</span> results:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f&quot;\nLast <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> read values before stopping:&quot;</span>)</span><br><span class="line">             start_print_index = <span class="built_in">max</span>(<span class="number">1</span>, i - <span class="built_in">len</span>(results) + <span class="number">1</span>) <span class="comment"># i 是停止时的循环次数</span></span><br><span class="line">             <span class="keyword">for</span> k, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):</span><br><span class="line">                original_index = start_print_index + k</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  Read #<span class="subst">&#123;original_index&#125;</span>: <span class="subst">&#123;val.<span class="built_in">hex</span>()&#125;</span> (<span class="subst">&#123;val!r&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>) <span class="comment"># 失败退出</span></span><br></pre></td></tr></table></figure>
<p>更快</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo python test5.py</span><br><span class="line">Target: 64:B7:08:61:B9:7E</span><br><span class="line">Handle to read repeatedly: 0x3e</span><br><span class="line">Number of reads required: 1000</span><br><span class="line">Maximum execution time: 180 seconds</span><br><span class="line">Will store and print last 10 results.</span><br><span class="line">Will report first detected value change.</span><br><span class="line">Connecting...</span><br><span class="line">Connected.</span><br><span class="line">Reading 1000/1000 (Elapsed: 80s)...</span><br><span class="line"></span><br><span class="line">Successfully completed 1000 reads.</span><br><span class="line">Disconnecting...</span><br><span class="line"></span><br><span class="line">Total execution time: 0:01:20.515156</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同样成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x003e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">6ffcd214ffebdc0d069e</span><br></pre></td></tr></table></figure>

<h2 id="0x11-订阅gatt-notify"><a href="#0x11-订阅gatt-notify" class="headerlink" title="0x11 订阅gatt notify"></a>0x11 订阅gatt notify</h2><p>%% 查看 handle 0x0040 和 google search gatt 通知。gatttool 等一些工具能够订阅 gatt 通知 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0040 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Listen to me for a single notification</p>
<blockquote>
<p>Notifications are unsolicited PDUs of type ATT_HANDLE_VALUE_NTF that are sent by a server to a client. No reply PDU is defined.  通知是由服务器发送到客户端的 ATT_HANDLE_VALUE_NTF 类型的未经请求的 PDU。未定义应答 PDU。</p>
</blockquote>
<p>指示和通知是可以通过 attribute（ATT） 协议发送的命令。因此，在 ATT 层定义了两个角色：客户端和服务器。指示和通知是 GATT 客户端订阅 GATT 服务器提供的数据的一种方式。客户端必须通过其客户端特征配置描述符为特征的值配置 Indications 和 Notifications，以便在每次在服务器上更新特征的值时收到通知。<br><strong>指示Indications</strong>需要由客户确认。服务器在从客户端获取回知之前不会发送以下指示。客户端向服务器发送了一条确认消息;这样 Server 就知道消息到达了 Client。因此，通过指示进行通信的速度较慢。<br><strong>通知Notifications</strong>不需要确认，因此速度更快。因此，服务器不知道消息是否到达客户端。</p>
<h3 id="检查notify设置"><a href="#检查notify设置" class="headerlink" title="检查notify设置"></a>检查notify设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --characteristics   </span><br><span class="line">handle = 0x003f, char properties = 0x1a, char value handle = 0x0040, uuid = 0000ff0c-0000-1000-8000-00805f9b34fb</span><br></pre></td></tr></table></figure>
<ul>
<li>句柄0x003f是该特征的<strong>声明句柄</strong>（Characteristic Declaration）</li>
<li>句柄0x0040是该特征的<strong>值句柄</strong>（Characteristic Value）</li>
<li>客户端通过句柄0x0040进行读写和订阅通知</li>
<li>uuid为自定义uuid</li>
</ul>
<ol>
<li><strong>特征属性位掩码 (Characteristic Properties Bitfield):</strong></li>
</ol>
<table>
<thead>
<tr>
<th>属性</th>
<th>十六进制值</th>
<th>二进制位</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Broadcast</td>
<td>0x01</td>
<td>0000 0001</td>
<td>广播</td>
</tr>
<tr>
<td>Read</td>
<td>0x02</td>
<td>0000 0010</td>
<td>允许读取</td>
</tr>
<tr>
<td>Write Without Resp</td>
<td>0x04</td>
<td>0000 0100</td>
<td>允许无响应写入</td>
</tr>
<tr>
<td>Write</td>
<td>0x08</td>
<td>0000 1000</td>
<td>允许带响应写入</td>
</tr>
<tr>
<td>Notify</td>
<td>0x10</td>
<td>0001 0000</td>
<td>允许通知</td>
</tr>
<tr>
<td>Indicate</td>
<td>0x20</td>
<td>0010 0000</td>
<td>允许指示</td>
</tr>
<tr>
<td>Authenticated Write</td>
<td>0x40</td>
<td>0100 0000</td>
<td>认证写入</td>
</tr>
<tr>
<td>Extended Properties</td>
<td>0x80</td>
<td>1000 0000</td>
<td>扩展属性</td>
</tr>
</tbody></table>
<ol start="2">
<li><strong>解码 0x1a:</strong><ul>
<li>我们将十六进制值 0x1a 转换为二进制：0001 1010。</li>
<li>现在我们按位检查：<ul>
<li>Bit 0 (值 0x01): …0 - Broadcast 未设置。</li>
<li><strong>Bit 1 (值 0x02):</strong> …1. - <strong>Read 设置。</strong> (0x1a &amp; 0x02 &#x3D; 0x02 !&#x3D; 0)</li>
<li>Bit 2 (值 0x04): ..0. - Write Without Response 未设置。</li>
<li><strong>Bit 3 (值 0x08):</strong> .1.. - <strong>Write 设置。</strong> (0x1a &amp; 0x08 &#x3D; 0x08 !&#x3D; 0</li>
<li><strong>Bit 4 (值 0x10):</strong> 1… - <strong>Notify 设置。</strong> (0x1a &amp; 0x10 &#x3D; 0x10 !&#x3D; 0)</li>
</ul>
</li>
<li><strong>结论:</strong> 因此，属性值 0x1a 表示该特征支持 <strong>Read</strong>、<strong>Write</strong> (Write Request) 和 <strong>Notify</strong> 操作</li>
</ul>
</li>
</ol>
<h3 id="测试目标句柄0x0040"><a href="#测试目标句柄0x0040" class="headerlink" title="测试目标句柄0x0040"></a>测试目标句柄0x0040</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0040 -n 01 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0040 value: 35 65 63 33 37 37 32 62 63 64 30 30 63 66 30 36 64 38 65 62 </span><br><span class="line">^C</span><br><span class="line">   </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0040 -n 02 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0040 value: 35 65 63 33 37 37 32 62 63 64 30 30 63 66 30 36 64 38 65 62</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0041 -n 0100 --listen</span><br><span class="line">Characteristic Write Request failed: Attribute can&#x27;t be written</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0041 -n 00 --listen </span><br><span class="line">Characteristic Write Request failed: Attribute can&#x27;t be written</span><br><span class="line">^C</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意--listen的用法</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果什么也不做只是listen是listen不到的</span></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E   --listen </span><br><span class="line">Usage:</span><br><span class="line">  gatttool [OPTION?]</span><br><span class="line"></span><br><span class="line">Help Options:</span><br><span class="line">  -h, --help                                Show help options</span><br><span class="line">  --help-all                                Show all help options</span><br><span class="line">  --help-gatt                               Show all GATT commands</span><br><span class="line">  --help-params                             Show all Primary Services/Characteristics arguments</span><br><span class="line">  --help-char-read-write                    Show all Characteristics Value/Descriptor Read/Write arguments</span><br><span class="line"></span><br><span class="line">Application Options:</span><br><span class="line">  -i, --adapter=hciX                        Specify local adapter interface</span><br><span class="line">  -b, --device=MAC                          Specify remote Bluetooth address</span><br><span class="line">  -t, --addr-type=[public | random]         Set LE address type. Default: public</span><br><span class="line">  -m, --mtu=MTU                             Specify the MTU size</span><br><span class="line">  -p, --psm=PSM                             Specify the PSM for GATT/ATT over BR/EDR</span><br><span class="line">  -l, --sec-level=[low | medium | high]     Set security level. Default: low</span><br><span class="line">  -I, --interactive                         Use interactive mode</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><strong>Notify (通知):</strong> 是特征的一种<strong>属性 (Property)<strong>。如果一个特征具有 Notify 属性，意味着</strong>服务器 (Peripheral，例如 BLECTF 设备)</strong> 可以在其值<strong>发生改变</strong>时，<strong>主动地、无需客户端请求</strong>地将新值发送给<strong>已订阅</strong>该通知的**客户端 (Central，例如你的 Kali 机器)**。<br>向句柄0x0040写入任何值都会触发通知，这个通知就是目标字符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> notify_data[<span class="number">20</span>] = <span class="string">&quot;5ec3772bcd00cf06d8eb&quot;</span>; <span class="comment">// 这是要发送的通知数据</span></span><br><span class="line"><span class="comment">// 将句柄 0x0040 的值重置回初始指令</span></span><br><span class="line">esp_ble_gatts_set_attr_value(blectf_handle_table[IDX_CHAR_FLAG_NOTIFICATION]+<span class="number">1</span>, <span class="keyword">sizeof</span>(notification_read_value)<span class="number">-1</span>, (<span class="type">uint8_t</span> *)notification_read_value);</span><br><span class="line"><span class="comment">// 发送通知，通知的句柄是特征值句柄，通知的数据是 notify_data</span></span><br><span class="line">esp_ble_gatts_send_indicate(gatts_if, param-&gt;write.conn_id, blectf_handle_table[IDX_CHAR_VAL_FLAG_NOTIFICATION], <span class="keyword">sizeof</span>(notify_data), (<span class="type">uint8_t</span> *)notify_data, <span class="literal">false</span>); <span class="comment">// false 表示是 Notification 而不是 Indication</span></span><br></pre></td></tr></table></figure>

<p>这是收到的日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gatttool[176501]: &lt; ACL Data TX: Handle 70 flags 0x00 dlen 8                                        #213 [hci0] 3098.759446</span><br><span class="line">      ATT: Write Request (0x12) len 3</span><br><span class="line">        Handle: 0x0040</span><br><span class="line">          Data[1]: 02</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#214 [hci0] 3098.799759</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 70 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #213: len 8 (1 Kb/s)</span><br><span class="line">        Latency: 40 msec (40-40 msec ~40 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 70 flags 0x02 dlen 5                                                          <span class="comment">#215 [hci0] 3098.843632</span></span></span><br><span class="line">      ATT: Write Response (0x13) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 70 flags 0x02 dlen 27                                                         <span class="comment">#216 [hci0] 3098.843644</span></span></span><br><span class="line">      ATT: Handle Value Notification (0x1b) len 22</span><br><span class="line">        Handle: 0x0040</span><br><span class="line">          Data[20]: 3565633337373262636430306366303664386562</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>[!NOTE]<br>在这里留一个疑问，当我在现实中遇到了蓝牙设备我会来确认这点的<br>“ 这个结论<strong>仅适用于这个特定设备和句柄 0x0040</strong>，因为它的行为是由其独特的源代码逻辑决定的。对于其他标准的 BLE 设备或其他特征，你仍然需要遵循写入 CCCD 来启用通知的标准流程。”&gt; </p>
</blockquote>
<h2 id="0x12-查看gatt-indicate"><a href="#0x12-查看gatt-indicate" class="headerlink" title="0x12 查看gatt indicate"></a>0x12 查看gatt indicate</h2><p>%% 查看 handle 0x0042 和 google search gatt indicate。对于单个响应指示消息，例如此挑战，gatttool 等工具将正常工作。 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0042 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Listen to handle 0x0044 for a single indication<br>参照0x11来听就可以了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0042 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Listen to handle 0x0044 for a single indication</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0044 -n 02 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Indication   handle = 0x0044 value: 63 37 62 38 36 64 64 31 32 31 38 34 38 63 37 37 63 31 31 33 </span><br><span class="line">^C</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在源码能直接核对答案了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(writeData,<span class="string">&quot;c7b86dd121848c77c113&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">//indicate</span></span><br><span class="line">                        flag_state[<span class="number">11</span>] = <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>

<p>作为一个 indication，客户端（kali)应该返回一个回应这个过程才算是完成了，但是这里我们只需要接受信息（题目要求只需要听）<br>这是它相关的日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gatttool[174176]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 8                                        #190 [hci0] 2811.800923</span><br><span class="line">      ATT: Write Request (0x12) len 3</span><br><span class="line">        Handle: 0x0044</span><br><span class="line">          Data[1]: 02</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#191 [hci0] 2811.840726</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #190: len 8 (1 Kb/s)</span><br><span class="line">        Latency: 39 msec (39-39 msec ~39 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 5                                                          <span class="comment">#192 [hci0] 2811.887299</span></span></span><br><span class="line">      ATT: Write Response (0x13) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#193 [hci0] 2811.887312</span></span></span><br><span class="line">      ATT: Handle Value Indication (0x1d) len 22</span><br><span class="line">        Handle: 0x0044</span><br><span class="line">          Data[20]: 6337623836646431323138343863373763313133</span><br><span class="line">gatttool[174176]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 5                                        #194 [hci0] 2811.887499</span><br><span class="line">      ATT: Handle Value Confirmation (0x1e) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#195 [hci0] 2811.927611</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #194: len 5 (1 Kb/s)</span><br><span class="line">        Latency: 40 msec (39-40 msec ~39 msec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是对日志的解释，它自动处理了“客户端的确认”</p>
<ol>
<li><strong><code>gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0044 -n 02 --listen</code></strong>: 这是你执行的命令，向蓝牙地址为<code>64:B7:08:61:B9:7E</code>的设备句柄<code>0x0044</code>写入<code>0x02</code>，并监听响应。</li>
<li><strong><code>ACL Data TX: Handle 71 ... ATT: Write Request (0x12) len 3 ... Handle: 0x0044 Data[1]: 02</code></strong>: <code>gatttool</code>发送了一个ATT Write Request，句柄是<code>0x0044</code>，写入的数据是<code>0x02</code>。 <code>Handle 71</code> 指的是客户端与服务器之间连接的句柄。</li>
<li><strong><code>HCI Event: Number of Completed Packets (0x13) ... Handle: 71 ... Count: 1</code></strong>: HCI事件表明之前发送的数据包已经成功传输。</li>
<li><strong><code>ACL Data RX: Handle 71 ... ATT: Write Response (0x13) len 0</code></strong>: 服务器发送了一个ATT Write Response，表示成功接收到写入请求。</li>
<li><strong><code>ACL Data RX: Handle 71 ... ATT: Handle Value Indication (0x1d) len 22 ... Handle: 0x0044 Data: 6337623836646431323138343863373763313133</code></strong>: 关键的一行！服务器发送了一个ATT Handle Value Indication。<ul>
<li><code>Handle: 0x0044</code>：表明Indication是针对句柄<code>0x0044</code>的。</li>
<li><code>Data: 6337623836646431323138343863373763313133</code>：这是Indication携带的数据，总共20个字节，内容是<code>6337623836646431323138343863373763313133</code>。</li>
</ul>
</li>
<li><strong><code>ACL Data TX: Handle 71 ... ATT: Handle Value Confirmation (0x1e) len 0</code></strong>: <code>gatttool</code>发送了一个ATT Handle Value Confirmation，表示已经接收到Indication。</li>
</ol>
<h2 id="0x13-读取多个notify"><a href="#0x13-读取多个notify" class="headerlink" title="0x13 读取多个notify"></a>0x13 读取多个notify</h2><p>%% 查看 处理 0x0046 并按照它所说的去做。请记住，此通知 clallange 要求您收到多个回复才能完成。<br> %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0046 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Listen to me for multi notifications<br>听到更多的通知</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0046 -n 02 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0046 value: 55 20 6e 6f 20 77 61 6e 74 20 74 68 69 73 20 6d 73 67 00 00 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>日志是这样的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">gatttool[179010]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 8                                        #294 [hci0] 3401.231380</span><br><span class="line">      ATT: Write Request (0x12) len 3</span><br><span class="line">        Handle: 0x0046</span><br><span class="line">          Data[1]: 02</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Command Status (0x0f) plen 4                                                           <span class="comment">#295 [hci0] 3401.232129</span></span></span><br><span class="line">      NOP (0x00|0x0000) ncmd 1</span><br><span class="line">        Status: Success (0x00)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#296 [hci0] 3401.271124</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #294: len 8 (1 Kb/s)</span><br><span class="line">        Latency: 39 msec (39-39 msec ~39 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: LE Meta Event (0x3e) plen 12                                                           <span class="comment">#297 [hci0] 3401.310917</span></span></span><br><span class="line">      LE Read Remote Used Features (0x04)</span><br><span class="line">        Status: Success (0x00)</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Features: 0xff 0x00 0x00 0x00 0x00 0x00 0x00 0x00</span><br><span class="line">          LE Encryption</span><br><span class="line">          Connection Parameter Request Procedure</span><br><span class="line">          Extended Reject Indication</span><br><span class="line">          Peripheral-initiated Features Exchange</span><br><span class="line">          LE Ping</span><br><span class="line">          LE Data Packet Length Extension</span><br><span class="line">          LL Privacy</span><br><span class="line">          Extended Scanner Filter Policies</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 5                                                          <span class="comment">#298 [hci0] 3401.315294</span></span></span><br><span class="line">      ATT: Write Response (0x13) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#299 [hci0] 3401.315301</span></span></span><br><span class="line">      ATT: Handle Value Notification (0x1b) len 22</span><br><span class="line">        Handle: 0x0046</span><br><span class="line">          Data[20]: 55206e6f2077616e742074686973206d73670000</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#300 [hci0] 3402.315328</span></span></span><br><span class="line">      ATT: Handle Value Notification (0x1b) len 22</span><br><span class="line">        Handle: 0x0046</span><br><span class="line">          Data[20]: 6339343537646535666438636166653334396664</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#301 [hci0] 3403.315400</span></span></span><br><span class="line">      ATT: Handle Value Notification (0x1b) len 22</span><br><span class="line">        Handle: 0x0046</span><br><span class="line">          Data[20]: 6339343537646535666438636166653334396664</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#302 [hci0] 3404.315311</span></span></span><br><span class="line">      ATT: Handle Value Notification (0x1b) len 22</span><br><span class="line">        Handle: 0x0046</span><br><span class="line">          Data[20]: 6339343537646535666438636166653334396664</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>收到通知后等待一下就可以了，它会自动发送剩下的通知<br>对其<code>63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64</code> 解码后得到<code>c9457de5fd8cafe349fd</code></p>
<h2 id="0x14-读取多个indicate"><a href="#0x14-读取多个indicate" class="headerlink" title="0x14 读取多个indicate"></a>0x14 读取多个indicate</h2><p>%% 查看 handle 0x0042 和 google search gatt 指示。请记住，此 chalange 将要求您解析多个 indicate 响应才能完成 chalange。 %%<br>读取要求<br>注意，这里写错了，不是0x0042,是0x0048</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0048 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Listen to handle 0x004a for multi indications<br>依旧是等待一会就可以了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0048 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Listen to handle 0x004a for multi indications</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x004a -n 02 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Indication   handle = 0x004a value: 55 20 6e 6f 20 77 61 6e 74 20 74 68 69 73 20 6d 73 67 00 00 </span><br><span class="line">Indication   handle = 0x004a value: 62 36 66 33 61 34 37 66 32 30 37 64 33 38 65 31 36 66 66 61 </span><br><span class="line">Indication   handle = 0x004a value: 62 36 66 33 61 34 37 66 32 30 37 64 33 38 65 31 36 66 66 61 </span><br><span class="line">Indication   handle = 0x004a value: 62 36 66 33 61 34 37 66 32 30 37 64 33 38 65 31 36 66 66 61 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对应的日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">gatttool[183635]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 8                                        #481 [hci0] 3972.157187</span><br><span class="line">      ATT: Write Request (0x12) len 3</span><br><span class="line">        Handle: 0x004a</span><br><span class="line">          Data[1]: 02</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#482 [hci0] 3972.196904</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #481: len 8 (1 Kb/s)</span><br><span class="line">        Latency: 39 msec (39-39 msec ~39 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 5                                                          <span class="comment">#483 [hci0] 3972.243389</span></span></span><br><span class="line">      ATT: Write Response (0x13) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#484 [hci0] 3972.243405</span></span></span><br><span class="line">      ATT: Handle Value Indication (0x1d) len 22</span><br><span class="line">        Handle: 0x004a</span><br><span class="line">          Data[20]: 55206e6f2077616e742074686973206d73670000</span><br><span class="line">gatttool[183635]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 5                                        #485 [hci0] 3972.244208</span><br><span class="line">      ATT: Handle Value Confirmation (0x1e) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#486 [hci0] 3972.276942</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #485: len 5 (1 Kb/s)</span><br><span class="line">        Latency: 32 msec (32-39 msec ~36 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#487 [hci0] 3972.323414</span></span></span><br><span class="line">      ATT: Handle Value Indication (0x1d) len 22</span><br><span class="line">        Handle: 0x004a</span><br><span class="line">          Data[20]: 6236663361343766323037643338653136666661</span><br><span class="line">gatttool[183635]: &lt; ACL Data TX: Handle 71 flags 0x00 dlen 5                                        #488 [hci0] 3972.323538</span><br><span class="line">      ATT: Handle Value Confirmation (0x1e) len 0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">HCI Event: Number of Completed Packets (0x13) plen 5                                              <span class="comment">#489 [hci0] 3972.356801</span></span></span><br><span class="line">        Num handles: 1</span><br><span class="line">        Handle: 71 Address: 64:B7:08:61:B9:7E (Espressif Inc.)</span><br><span class="line">        Count: 1</span><br><span class="line">        #488: len 5 (1 Kb/s)</span><br><span class="line">        Latency: 33 msec (32-39 msec ~34 msec)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ACL Data RX: Handle 71 flags 0x02 dlen 27                                                         <span class="comment">#490 [hci0] 3972.411338</span></span></span><br><span class="line">      ATT: Handle Value Indication (0x1d) len 22</span><br><span class="line">        Handle: 0x004a</span><br><span class="line">          Data[20]: 6236663361343766323037643338653136666661</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>解码得到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">62 36 66 33 61 34 37 66 32 30 37 64 33 38 65 31 36 66 66 61 </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo &quot;6236663361343766323037643338653136666661&quot; | xxd -r -p </span><br><span class="line">b6f3a47f207d38e16ffa                                                                                    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x15-修改蓝牙mac地址"><a href="#0x15-修改蓝牙mac地址" class="headerlink" title="0x15 修改蓝牙mac地址"></a>0x15 修改蓝牙mac地址</h2><p>%% 查看 处理 0x004c 并按照它所说的去做。与以太网或 wifi 设备非常相似，您也可以更改蓝牙设备的 mac 地址。 %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004c | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Connect with BT MAC address 11:22:33:44:55:66<br>当有设备连接时，它会检查连接过来的设备的 MAC 地址。只有当连接设备的 MAC 地址正好是 11:22:33:44:55:66 时，它才会认为这个连接是“特殊”的或“授权”的，并触发某个成功的状态（例如，更新某个特征的值，像源代码里处理 MAC 地址匹配的部分）。</p>
<p>这是我自己当前的蓝牙地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ hciconfig        </span><br><span class="line">hci0:   Type: Primary  Bus: USB</span><br><span class="line">        BD Address: 84:E0:F4:03:0F:5E  ACL MTU: 310:10  SCO MTU: 64:8</span><br><span class="line">        UP RUNNING </span><br><span class="line">        RX bytes:7079 acl:107 sco:0 events:414 errors:0</span><br><span class="line">        TX bytes:6887 acl:85 sco:0 commands:214 errors:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="bdaddr"><a href="#bdaddr" class="headerlink" title="bdaddr"></a>bdaddr</h3><p>在这里使用bdaddr来对地址进行修改，会显示安装失败，也没有办法找到它的安装包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install bluez-utils</span><br></pre></td></tr></table></figure>
<p>使用bdaddr会简单方便很多，但是它在新版本中好像不存在了<br>方法如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo hciconfig hci0 down</span><br><span class="line">sudo bdaddr -i hci0 11:22:33:44:55:66</span><br><span class="line">sudo hciconfig hci0 up</span><br></pre></td></tr></table></figure>


<h3 id="btmgmt"><a href="#btmgmt" class="headerlink" title="btmgmt"></a>btmgmt</h3><p>这里找到了另外一个工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">└─$ sudo btmgmt                     </span><br><span class="line"><span class="meta prompt_">[mgmt]# </span><span class="language-bash"><span class="built_in">help</span></span></span><br><span class="line">Menu mgmt:</span><br><span class="line">Available commands:</span><br><span class="line">-------------------</span><br><span class="line">monitor                                           Advertisement Monitor Submenu</span><br><span class="line">select &lt;index&gt;                                    Select a different index</span><br><span class="line">revision                                          Get the MGMT Revision</span><br><span class="line">commands                                          List supported commands</span><br><span class="line">config                                            Show configuration info</span><br><span class="line">info                                              Show controller info</span><br><span class="line">extinfo                                           Show extended controller info</span><br><span class="line">auto-power                                        Power all available features</span><br><span class="line">power &lt;on/off&gt;                                    Toggle powered state</span><br><span class="line">discov &lt;yes/no/limited&gt; [timeout]                 Toggle discoverable state</span><br><span class="line">connectable &lt;on/off&gt;                              Toggle connectable state</span><br><span class="line">fast-conn &lt;on/off&gt;                                Toggle fast connectable state</span><br><span class="line">bondable &lt;on/off&gt;                                 Toggle bondable state</span><br><span class="line">pairable &lt;on/off&gt;                                 Toggle bondable state</span><br><span class="line">linksec &lt;on/off&gt;                                  Toggle link level security</span><br><span class="line">ssp &lt;on/off&gt;                                      Toggle SSP mode</span><br><span class="line">sc &lt;on/off/only&gt;                                  Toggle SC support</span><br><span class="line">hs &lt;on/off&gt;                                       Toggle HS support</span><br><span class="line">le &lt;on/off&gt;                                       Toggle LE support</span><br><span class="line">advertising &lt;on/off&gt;                              Toggle LE advertising</span><br><span class="line">bredr &lt;on/off&gt;                                    Toggle BR/EDR support</span><br><span class="line">privacy &lt;on/off&gt; [irk]                            Toggle privacy support</span><br><span class="line">class &lt;major&gt; &lt;minor&gt;                             Set device major/minor class</span><br><span class="line">disconnect [-t type] &lt;remote address&gt;             Disconnect device</span><br><span class="line">con                                               List connections</span><br><span class="line">find [-l|-b] [-L]                                 Discover nearby devices</span><br><span class="line">find-service [-u UUID] [-r RSSI_Threshold] [-l|-b] Discover nearby service</span><br><span class="line">stop-find [-l|-b]                                 Stop discovery</span><br><span class="line">name &lt;name&gt; [shortname]                           Set local name</span><br><span class="line">pair [-c cap] [-t type] &lt;remote address&gt;          Pair with a remote device</span><br><span class="line">cancelpair [-t type] &lt;remote address&gt;             Cancel pairing</span><br><span class="line">unpair [-t type] &lt;remote address&gt;                 Unpair device</span><br><span class="line">keys                                              Load Link Keys</span><br><span class="line">ltks                                              Load Long Term Keys</span><br><span class="line">irks [--local index] [--file file path]           Load Identity Resolving Keys</span><br><span class="line">block [-t type] &lt;remote address&gt;                  Block Device</span><br><span class="line">unblock [-t type] &lt;remote address&gt;                Unblock Device</span><br><span class="line">add-uuid &lt;UUID&gt; &lt;service class hint&gt;              Add UUID</span><br><span class="line">rm-uuid &lt;UUID&gt;                                    Remove UUID</span><br><span class="line">clr-uuids                                         Clear UUIDs</span><br><span class="line">local-oob                                         Local OOB data</span><br><span class="line">remote-oob [-t &lt;addr_type&gt;] [-r &lt;rand192&gt;] [-h &lt;hash192&gt;] [-R &lt;rand256&gt;] [-H &lt;hash256&gt;] &lt;addr&gt; Remote OOB data</span><br><span class="line">did &lt;source&gt;:&lt;vendor&gt;:&lt;product&gt;:&lt;version&gt;         Set Device ID</span><br><span class="line">static-addr &lt;address&gt;                             Set static address</span><br><span class="line">public-addr &lt;address&gt;                             Set public address</span><br><span class="line">ext-config &lt;on/off&gt;                               External configuration</span><br><span class="line">debug-keys &lt;on/off&gt;                               Toggle debug keys</span><br><span class="line">conn-info [-t type] &lt;remote address&gt;              Get connection information</span><br><span class="line">io-cap &lt;cap&gt;                                      Set IO Capability</span><br><span class="line">scan-params &lt;interval&gt; &lt;window&gt;                   Set Scan Parameters</span><br><span class="line">get-clock [address]                               Get Clock Information</span><br><span class="line">add-device [-a action] [-t type] &lt;address&gt;        Add Device</span><br><span class="line">del-device [-t type] &lt;address&gt;                    Remove Device</span><br><span class="line">clr-devices                                       Clear Devices</span><br><span class="line">bredr-oob                                         Local OOB data (BR/EDR)</span><br><span class="line">le-oob                                            Local OOB data (LE)</span><br><span class="line">advinfo                                           Show advertising features</span><br><span class="line">advsize [options] &lt;instance_id&gt;                   Show advertising size info</span><br><span class="line">add-adv [options] &lt;instance_id&gt;                   Add advertising instance</span><br><span class="line">rm-adv &lt;instance_id&gt;                              Remove advertising instance</span><br><span class="line">clr-adv                                           Clear advertising instances</span><br><span class="line">add-ext-adv-params [options] &lt;instance_id&gt;        Add extended advertising params</span><br><span class="line">add-ext-adv-data [options] &lt;instance_id&gt;          Add extended advertising data</span><br><span class="line">appearance &lt;appearance&gt;                           Set appearance</span><br><span class="line">phy [LE1MTX] [LE1MRX] [LE2MTX] [LE2MRX] [LECODEDTX] [LECODEDRX] [BR1M1SLOT] [BR1M3SLOT] [BR1M5SLOT][EDR2M1SLOT] [EDR2M3SLOT] [EDR2M5SLOT][EDR3M1SLOT] [EDR3M3SLOT] [EDR3M5SLOT] Get/Set PHY Configuration</span><br><span class="line">wbs &lt;on/off&gt;                                      Toggle Wideband-Speech support</span><br><span class="line">secinfo                                           Show security information</span><br><span class="line">expinfo                                           Show experimental features</span><br><span class="line">exp-debug &lt;on/off&gt;                                Set debug feature</span><br><span class="line">exp-privacy &lt;on/off&gt;                              Set LL privacy feature</span><br><span class="line">exp-quality &lt;on/off&gt;                              Set bluetooth quality report feature</span><br><span class="line">exp-offload &lt;on/off&gt;                              Toggle codec support</span><br><span class="line">read-sysconfig                                    Read System Configuration</span><br><span class="line">set-sysconfig &lt;-v|-h&gt; [options...]                Set System Configuration</span><br><span class="line">get-flags [-t type] &lt;address&gt;                     Get device flags</span><br><span class="line">set-flags [-f flags] [-t type] &lt;address&gt;          Set device flags</span><br><span class="line">menu &lt;name&gt;                                       Select submenu</span><br><span class="line">version                                           Display version</span><br><span class="line">quit                                              Quit program</span><br><span class="line">exit                                              Quit program</span><br><span class="line">help                                              Display help about this program</span><br><span class="line">export                                            Print environment variables</span><br><span class="line">script &lt;filename&gt;      </span><br></pre></td></tr></table></figure>

<p>使用方法如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 进入 btmgmt 交互模式</span></span><br><span class="line">sudo btmgmt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 选择适配器</span></span><br><span class="line">select hci0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 关闭电源</span></span><br><span class="line">power off</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等待确认</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 设置静态地址</span></span><br><span class="line">set-static-addr 11:22:33:44:55:66</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">观察是否报错</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. 打开电源</span></span><br><span class="line">power on</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等待确认</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. 查看信息确认</span></span><br><span class="line">info</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查输出中的 <span class="string">&quot;current settings&quot;</span> 部分，看 public address 或 static address 是否改变</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：<span class="string">&#x27;info&#x27;</span> 命令可能仍然显示硬件的公共地址，但连接时使用的地址可能已经变成静态地址了。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. 退出</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. 尝试连接目标设备</span></span><br><span class="line">sudo bluetoothctl</span><br><span class="line">connect 64:B7:08:61:B9:7E</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查目标设备上的状态是否按预期改变</span></span><br></pre></td></tr></table></figure>



<p>这段时间的部分日志<br>从这几分日志可以得到：当前的蓝牙适配器 (hci0, CSR8510 A10) 和其驱动程序组合，不支持通过 btmgmt 工具的 public-addr 或 set-static-addr 命令来伪装 MAC 地址。<br>btmon</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">= Close Index: 84:E0:F4:03:0F:5E                                                                         [hci0] 5495.330780</span><br><span class="line">btmgmt[193534]: @ MGMT Command: Set Public Address (0x0039) plen 6                              &#123;0x0002&#125; [hci0] 5555.288257</span><br><span class="line">        Address: 11:22:33:44:55:66 (OUI 11-22-33)</span><br><span class="line">@ MGMT Event: Command Status (0x0002) plen 3                                                    &#123;0x0002&#125; [hci0] 5555.288272</span><br><span class="line">      Set Public Address (0x0039)</span><br><span class="line">        Status: Not Supported (0x0c)</span><br><span class="line">btmgmt[193534]: @ MGMT Command: Set Powered (0x0005) plen 1                                     &#123;0x0002&#125; [hci0] 5574.242334</span><br><span class="line">        Powered: Enabled (0x01)</span><br><span class="line">= Open Index: 84:E0:F4:03:0F:5E      </span><br></pre></td></tr></table></figure>
<p>btmgmt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[mgmt]# select hci0</span><br><span class="line">Selected index 0</span><br><span class="line">[hci0]# power off</span><br><span class="line">[hci0]# hci0 Set Powered complete, settings: bondable ssp br/edr le secure-conn </span><br><span class="line">[hci0]# hci0 class of device changed: 0x000000</span><br><span class="line">[hci0]# set-static-addr 11:22:33:44:55:66</span><br><span class="line">Invalid command in menu mgmt: set-static-addr</span><br><span class="line"></span><br><span class="line">Use &quot;help&quot; for a list of available commands in a menu.</span><br><span class="line">Use &quot;menu &lt;submenu&gt;&quot; if you want to enter any submenu.</span><br><span class="line">Use &quot;back&quot; if you want to return to menu main.</span><br><span class="line">[hci0]# public-addr 11:22:33:44:55:66</span><br><span class="line">[hci0]# Set Public Address for hci0 failed with status 0x0c (Not Supported)</span><br><span class="line">[hci0]# power on                                                                                        </span><br><span class="line">[hci0]# hci0 class of device changed: 0x7c0000</span><br><span class="line">[hci0]# hci0 Set Powered complete, settings: powered bondable ssp br/edr le secure-conn </span><br><span class="line">[hci0]# info</span><br><span class="line">[hci0]# hci0:   Primary controller</span><br><span class="line">[hci0]#         addr 84:E0:F4:03:0F:5E version 6 manufacturer 10 class 0x7c0000</span><br><span class="line">[hci0]#         supported settings: powered connectable fast-connectable discoverable bondable link-security ssp br/edr le advertising secure-conn debug-keys privacy static-addr phy-configuration </span><br><span class="line">[hci0]#         current settings: powered bondable ssp br/edr le secure-conn </span><br><span class="line">[hci0]#         name kali</span><br><span class="line">[hci0]#         short name </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ifconnfig"><a href="#ifconnfig" class="headerlink" title="ifconnfig"></a>ifconnfig</h3><p>来自：<br>在 Linux 上，您可以使用命令 sudo hciconfig hci0 down 将蓝牙设备关闭，使用 sudo hciconfig hci0 hw ether NEW_MAC_ADDRESS 修改 MAC 地址，再用 sudo hciconfig hci0 up 重新启动设备<br>这个试了，不行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo hciconfig hci0 down</span><br><span class="line">sudo hciconfig hci0 hw ether 11:22:33:44:55:66</span><br><span class="line">sudo hciconfig hci0 up</span><br></pre></td></tr></table></figure>

<p>代码<br>也不行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_bluetooth_mac</span>(<span class="params">new_mac</span>):</span><br><span class="line">    <span class="comment"># 关闭设备</span></span><br><span class="line">    subprocess.call([<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;hciconfig&quot;</span>, <span class="string">&quot;hci0&quot;</span>, <span class="string">&quot;down&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 修改 MAC 地址</span></span><br><span class="line">    subprocess.call([<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;hciconfig&quot;</span>, <span class="string">&quot;hci0&quot;</span>, <span class="string">&quot;up&quot;</span>])</span><br><span class="line">    subprocess.call([<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;hciconfig&quot;</span>, <span class="string">&quot;hci0&quot;</span>, <span class="string">&quot;up&quot;</span>, new_mac])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重新启动设备</span></span><br><span class="line">    subprocess.call([<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;hciconfig&quot;</span>, <span class="string">&quot;hci0&quot;</span>, <span class="string">&quot;up&quot;</span>])</span><br><span class="line"></span><br><span class="line">new_mac = <span class="string">&quot;11:22:33:44:55:66&quot;</span>  <span class="comment"># 需要替换为新的 MAC 地址</span></span><br><span class="line">change_bluetooth_mac(new_mac)</span><br></pre></td></tr></table></figure>



<h3 id="物理修改"><a href="#物理修改" class="headerlink" title="物理修改"></a>物理修改</h3><p>找到了篇文章：<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/633839213" >https://zhuanlan.zhihu.com/p/633839213<i class="fas fa-external-link-alt"></i></a><br>等新的蓝牙适配器到了就来更新</p>
<h2 id="0x16-设置MTU"><a href="#0x16-设置MTU" class="headerlink" title="0x16 设置MTU"></a>0x16 设置MTU</h2><p>%% 阅读 handle 0x0048 并按照它所说的去做。设置 MTU 可能是一项棘手的事情。一些工具可能会提供 mtu 标志，但它们似乎并没有真正触发服务器上的 MTU 协商。尝试使用 gatttool 的交互模式来完成此任务。默认情况下，BLECTF 服务器设置为强制 MTU 大小为 20。服务器将监听 MTU 协商并查看它们，但我们并没有真正更改代码中的 MTU。如果您使用 handle 0x0048 中指定的值触发 MTU 事件，我们只触发标志代码。祝你好运！ %%</p>
<p>读取要求<br>注意这里应该是0x004e</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Set your connection MTU to 444</p>
<ul>
<li><strong>ATT MTU 协商:</strong> MTU 的大小是在<strong>连接建立后</strong>由客户端和服务器<strong>自动协商</strong>的。客户端会告知服务器它能支持的最大 MTU，服务器也会告知客户端它能支持的最大 MTU，最终双方会选择一个两者都能接受的最小值作为本次连接实际使用的 MTU。</li>
<li>gatttool的交互模式下有**<code>mtu &lt;value&gt;</code> 命令**，可以用来发起 MTU 交换请求。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌───(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Set your connection MTU to 444</span><br><span class="line"></span><br><span class="line">┌───(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E -I</span><br><span class="line">[64:B7:08:61:B9:7E][LE]&gt; connect</span><br><span class="line">Attempting to connect to 64:B7:08:61:B9:7E</span><br><span class="line">Connection successful</span><br><span class="line">[64:B7:08:61:B9:7E][LE]&gt; mtu</span><br><span class="line">Usage: mtu &lt;value&gt;</span><br><span class="line">[64:B7:08:61:B9:7E][LE]&gt; mtu 444 </span><br><span class="line">MTU was exchanged successfully: 444</span><br><span class="line">[64:B7:08:61:B9:7E][LE]&gt; char-read-hnd 0x004e</span><br><span class="line">Characteristic value/descriptor: 62 31 65 34 30 39 65 35 61 34 65 61 66 39 66 65 35 31 35 38 </span><br><span class="line">[64:B7:08:61:B9:7E][LE]&gt; </span><br><span class="line"></span><br><span class="line">┌───(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">b1e409e5a4eaf9fe5158</span><br><span class="line"></span><br></pre></td></tr></table></figure>
得到<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">62 31 65 34 30 39 65 35 61 34 65 61 66 39 66 65 35 31 35 38 </span><br><span class="line">b1e409e5a4eaf9fe5158</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用bluepy库"><a href="#使用bluepy库" class="headerlink" title="使用bluepy库"></a>使用bluepy库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bluepy <span class="keyword">import</span> btle</span><br><span class="line"></span><br><span class="line">DEVICE_ADDRESS = <span class="string">&quot;64:B7:08:61:B9:7E&quot;</span></span><br><span class="line">ADDR_TYPE = btle.ADDR_TYPE_PUBLIC</span><br><span class="line">REQUESTED_MTU = <span class="number">444</span></span><br><span class="line"><span class="comment"># 用于检查结果的状态句柄 (从源码看是 0xFF13 的值句柄)</span></span><br><span class="line">CHECK_HANDLE = <span class="number">0x004e</span> <span class="comment"># IDX_CHAR_FLAG_MTU + 1 (假设)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Connecting to <span class="subst">&#123;DEVICE_ADDRESS&#125;</span>...&quot;</span>)</span><br><span class="line">conn = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = btle.Peripheral(DEVICE_ADDRESS, ADDR_TYPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Requesting MTU size: <span class="subst">&#123;REQUESTED_MTU&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试设置 MTU</span></span><br><span class="line">        conn.setMTU(REQUESTED_MTU)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;MTU exchange likely completed (actual MTU depends on server).&quot;</span>)</span><br><span class="line">        <span class="comment"># 注意：setMTU 不会返回实际协商的 MTU，</span></span><br><span class="line">        <span class="comment"># Bluepy 没有标准方法直接获取协商后的 MTU。</span></span><br><span class="line">        <span class="comment"># 但请求已经发出。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 等待片刻让设备可能更新状态</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 读取状态句柄检查结果</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Reading check handle <span class="subst">&#123;<span class="built_in">hex</span>(CHECK_HANDLE)&#125;</span> to verify...&quot;</span>)</span><br><span class="line">        result_value = conn.readCharacteristic(CHECK_HANDLE)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Value read from check handle: <span class="subst">&#123;result_value.<span class="built_in">hex</span>()&#125;</span> (<span class="subst">&#123;result_value!r&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="comment"># 在这里判断 result_value 是否变成了预期的成功值</span></span><br><span class="line">        <span class="comment"># 例如，源码中是 &quot;b1e409e5a4eaf9fe5158&quot;</span></span><br><span class="line">        <span class="keyword">if</span> result_value == <span class="string">b&quot;b1e409e5a4eaf9fe5158&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;SUCCESS: Check handle value indicates MTU challenge likely completed!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Check handle value did not match expected success value.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error during MTU request or subsequent read: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> btle.BTLEException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Connection failed or Bluetooth error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.disconnect()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Disconnected.&quot;</span>)</span><br></pre></td></tr></table></figure>


<p>也成功了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Set your connection MTU to 444</span><br><span class="line"></span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo python test7.py</span><br><span class="line">Connecting to 64:B7:08:61:B9:7E...</span><br><span class="line">Connected.</span><br><span class="line">Requesting MTU size: 444</span><br><span class="line">MTU exchange likely completed (actual MTU depends on server).</span><br><span class="line">Reading check handle 0x4e to verify...</span><br><span class="line">Value read from check handle: 6231653430396535613465616639666535313538 (b&#x27;b1e409e5a4eaf9fe5158&#x27;)</span><br><span class="line">SUCCESS: Check handle value indicates MTU challenge likely completed!</span><br><span class="line">Disconnected.</span><br><span class="line">  </span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x004e | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">b1e409e5a4eaf9fe5158</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这次没有办法通过重新写入0x004e来改变0x004e的值，可以选择把esp32断电（从电脑拔出）再插回去，它就会初始化了，可以这样来进行多种方法的测试</p>
</blockquote>
<h2 id="0x17-写入响应ack信息"><a href="#0x17-写入响应ack信息" class="headerlink" title="0x17 写入响应ack信息"></a>0x17 写入响应ack信息</h2><p>%% 查看 处理 0x0050 并按照它所说的去做。此 chalange 与其他写入 chalange 不同，因为执行写入的工具需要正确实现写入响应 ack 消息。这个标志也很棘手，因为即使没有 “NOTIFY” 属性，该标志也会作为通知响应数据返回。 %%</p>
<p>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0050 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>Write+resp ‘hello’<br><strong>GATT特征的写入类型与响应机制</strong></p>
<ul>
<li><strong>写入带响应（Write with Response）</strong><br>  特征属性中<code>GATT_PROP_WRITE</code>（0x08）表示写入操作需要服务器返回确认响应（ACK），客户端写入后必须等待服务器确认写入成功。</li>
<li><strong>写入无响应（Write without Response）</strong><br>  属性<code>GATT_PROP_WRITE_NO_RSP</code>（0x04）允许客户端写入后不等待确认，提升效率但不保证写入成功。<br>本题强调“写入工具需要正确实现写入响应ACK”，说明目标特征支持<strong>带响应的写入</strong>，客户端必须处理写入确认包。<br>查看help,这次使用–char-write来写<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--char-write                              Characteristics Value Write Without Response (Write Command)</span><br><span class="line">--char-write-req                          Characteristics Value Write (Write Request)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0050 -n $(echo -n &quot;hello&quot;|xxd -ps)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0050 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">Write+resp &#x27;hello&#x27;  </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0050 -n $(echo -n &quot;hello&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0050 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">d41d8cd98f00b204e980</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h2 id="0x18-固件-is-boss"><a href="#0x18-固件-is-boss" class="headerlink" title="0x18 固件 is boss"></a>0x18 固件 is boss</h2><p>%% 看看 handle 0x0052。请注意，它没有 notify 属性。在这里写个字，无论如何都要听通知！事情并不总是像看起来那样！ %%<br>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0052 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>No notifications here! really?<br>向0x0052写入任意数据然后听0x0052的notify<br>先检查目标句柄的属性<br>0000 1010，只有读写两种属性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b  64:B7:08:61:B9:7E --characteristics |grep  &quot;0x0052&quot;</span><br><span class="line">handle = 0x0051, char properties = 0x0a, char value handle = 0x0052, uuid = 0000ff15-0000-1000-8000-00805f9b34fb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>按照0x11的方法继续听notify</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0052 -n 01 --listen</span><br></pre></td></tr></table></figure>

<p>听到了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0052 -n 01 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0052 value: 66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62 </span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo &quot;66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62&quot; | tr -d &#x27; &#x27; | xxd -r -p             </span><br><span class="line">fc920c68b6006169477b                                                                                                      </span><br></pre></td></tr></table></figure>

<p><strong>为什么没有notify属性还是会发送notify呢</strong><br>这是源码部分<br>代码会<strong>强制</strong>发送一个<strong>通知 (Notification)</strong> (因为 <code>esp_ble_gatts_send_indicate</code> 最后一个参数是 false)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// notify hidden notify flag</span></span><br><span class="line"><span class="keyword">if</span> (blectf_handle_table[IDX_CHAR_FLAG_HIDDEN_NOTIFY]+<span class="number">1</span> == param-&gt;write.handle) <span class="comment">// 检查是否写入 0x0052</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// indicate_handle_state = blectf_handle_table[IDX_CHAR_FLAG_HIDDEN_NOTIFY]; // 这行可能是遗留代码或用于其他目的</span></span><br><span class="line">    <span class="type">char</span> notify_data[<span class="number">20</span>] = <span class="string">&quot;fc920c68b6006169477b&quot;</span>; <span class="comment">// &lt;-- 要发送的通知数据 (Flag?)</span></span><br><span class="line">    <span class="comment">// 重置句柄 0x0052 的值为初始指令</span></span><br><span class="line">    esp_ble_gatts_set_attr_value(blectf_handle_table[IDX_CHAR_FLAG_HIDDEN_NOTIFY]+<span class="number">1</span>, <span class="keyword">sizeof</span>(hidden_notify_value)<span class="number">-1</span>, (<span class="type">uint8_t</span> *)hidden_notify_value);</span><br><span class="line">    <span class="comment">// 发送通知！即使属性没声明 Notify，也强制发送</span></span><br><span class="line">    esp_ble_gatts_send_indicate(gatts_if, param-&gt;write.conn_id, blectf_handle_table[IDX_CHAR_VAL_FLAG_HIDDEN_NOTIFY], <span class="keyword">sizeof</span>(notify_data), (<span class="type">uint8_t</span> *)notify_data, <span class="literal">false</span>); <span class="comment">// false = Notification</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>为什么可以这样设置，<strong>为什么没有notify属性依然能接收到notify信息</strong><br><strong>固件拥有最终控制权:</strong> 蓝牙协议栈（如 ESP-IDF 中的 BlueZ 衍生栈）提供了发送 GATT 操作（如通知、指示、读写响应）的 API 函数（例如 esp_ble_gatts_send_indicate）。设备端的应用程序（固件）代码可以在任何它认为合适的时机调用这些函数。<br><strong>固件开发者决定了设备的实际行为。</strong> 如果开发者编写代码，在收到对句柄 A 的写请求后，就调用函数向客户端发送一个关于句柄 B 的通知，那么设备就会这样做，<strong>即使句柄 B 的特征声明中没有 Notify 属性</strong>。<br>固件可以不完全遵守自己声明的属性.</p>
<h2 id="0x19-小总结"><a href="#0x19-小总结" class="headerlink" title="0x19 小总结"></a>0x19 小总结</h2><p>%% 查看 0x0054 上的所有 handle 属性！四处逛逛，找到你国旗的碎片。 %%<br>先检查属性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b  64:B7:08:61:B9:7E --characteristics |grep  &quot;0x0054&quot;       </span><br><span class="line">handle = 0x0053, char properties = 0x9b, char value handle = 0x0054, uuid = 0000ff16-0000-1000-8000-00805f9b34fb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0x9b&#x3D;10011011<br>对照这个表</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>十六进制值</th>
<th>二进制位</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Broadcast</td>
<td>0x01</td>
<td>0000 0001</td>
<td>广播</td>
</tr>
<tr>
<td>Read</td>
<td>0x02</td>
<td>0000 0010</td>
<td>允许读取</td>
</tr>
<tr>
<td>Write Without Resp</td>
<td>0x04</td>
<td>0000 0100</td>
<td>允许无响应写入</td>
</tr>
<tr>
<td>Write</td>
<td>0x08</td>
<td>0000 1000</td>
<td>允许带响应写入</td>
</tr>
<tr>
<td>Notify</td>
<td>0x10</td>
<td>0001 0000</td>
<td>允许通知</td>
</tr>
<tr>
<td>Indicate</td>
<td>0x20</td>
<td>0010 0000</td>
<td>允许指示</td>
</tr>
<tr>
<td>Authenticated Write</td>
<td>0x40</td>
<td>0100 0000</td>
<td>认证写入</td>
</tr>
<tr>
<td>Extended Properties</td>
<td>0x80</td>
<td>1000 0000</td>
<td>扩展属性</td>
</tr>
<tr>
<td>那么要关注的属性就是</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>扩展属性、notify、write、read、broadcast</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>一个个看</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0054 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">So many properties!</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write -a 0x0054 -n 01 --listen</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0054 -n 01 --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0054 value: 30 37 65 34 61 30 63 63 34 38 </span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0054 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">fbb966958f</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo &quot;30 37 65 34 61 30 63 63 34 38 &quot; | tr -d &#x27; &#x27; | xxd -r -p </span><br><span class="line">07e4a0cc48  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>拼接起来就好了<code>fbb966958f07e4a0cc48</code><br>这里运用的指令都是前面出现过的，还记得怎么用就行</p>
<h2 id="0x20"><a href="#0x20" class="headerlink" title="0x20"></a>0x20</h2><p>%% 找出作者的 twitter 句柄并按照 0x0056 告诉您的去做！ %%</p>
<p>读取要求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0056 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>
<p>作者的twitter是hackgnar</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0056 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">md5 of author&#x27;s twitter handle</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ echo -n &quot;hackgnar&quot; | md5sum</span><br><span class="line">fe40eb2449bda7f9a997331ac09424e7  -</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-write-req -a 0x0056 -n $(echo -n &quot;fe40eb2449bda7f9a997&quot;|xxd -ps)</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">                                                                                                        </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0056 | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | tr -d &#x27; &#x27; | xxd -r -p; printf &#x27;\n&#x27;</span><br><span class="line">fe40eb2449bda7f9a997</span><br><span class="line">                      </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是答案是<code>d953bfb9846acc2e15ee</code><br>这个答案只有前20个字符又很难还原最初的是什么</p>
<h2 id="记录报错"><a href="#记录报错" class="headerlink" title="记录报错"></a>记录报错</h2><h3 id="安装时报错"><a href="#安装时报错" class="headerlink" title="安装时报错"></a>安装时报错</h3><p>直接使用系统的esptool可能会报错（指安装途径为<code>sudo apt-get install esptool</code>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop/ble_ctf]</span><br><span class="line">└─$ esptool -p /dev/ttyUSB0 -b 460800 --before default_reset --after hard_reset --chip esp32  write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/ble_ctf.bin</span><br><span class="line"></span><br><span class="line">esptool.py v4.7.0</span><br><span class="line">Serial port /dev/ttyUSB0</span><br><span class="line">Connecting....</span><br><span class="line">Chip is ESP32-D0WDQ6 (revision v1.1)</span><br><span class="line">Features: WiFi, BT, Dual Core, 240MHz, VRef calibration in efuse, Coding Scheme None</span><br><span class="line">Crystal is 40MHz</span><br><span class="line">MAC: 8c:4f:00:c8:78:60</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/bin/esptool&quot;, line 37, in &lt;module&gt;</span><br><span class="line">    esptool._main()</span><br><span class="line">    ~~~~~~~~~~~~~^^</span><br><span class="line">  File &quot;/usr/lib/python3/dist-packages/esptool/__init__.py&quot;, line 1139, in _main</span><br><span class="line">    main()</span><br><span class="line">    ~~~~^^</span><br><span class="line">  File &quot;/usr/lib/python3/dist-packages/esptool/__init__.py&quot;, line 751, in main</span><br><span class="line">    esp = esp.run_stub()</span><br><span class="line">  File &quot;/usr/lib/python3/dist-packages/esptool/loader.py&quot;, line 996, in run_stub</span><br><span class="line">    stub = StubFlasher(get_stub_json_path(self.CHIP_NAME))</span><br><span class="line">  File &quot;/usr/lib/python3/dist-packages/esptool/loader.py&quot;, line 159, in __init__</span><br><span class="line">    with open(json_path) as json_file:</span><br><span class="line">         ~~~~^^^^^^^^^^^</span><br><span class="line">FileNotFoundError: [Errno 2] No such file or directory: &#x27;/usr/lib/python3/dist-packages/esptool/targets/stub_flasher/stub_flasher_32.json&#x27;                                                </span><br><span class="line">                                                 </span><br></pre></td></tr></table></figure>

<p>安装esptool</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install esptool -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后从git安装esptool.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/espressif/esptool.git</span><br></pre></td></tr></table></figure>
<p>尝试启动esptool.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python &#x27;/home/kali/Desktop/esptool/esptool.py&#x27; -h   </span><br></pre></td></tr></table></figure>

<p>如果报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop/ble_ctf]</span><br><span class="line">└─$ python &#x27;/home/kali/Desktop/esptool/esptool.py&#x27; -h</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/home/kali/Desktop/esptool/esptool.py&quot;, line 34, in &lt;module&gt;</span><br><span class="line">    import esptool</span><br><span class="line">  File &quot;/home/kali/Desktop/esptool/esptool/__init__.py&quot;, line 41, in &lt;module&gt;</span><br><span class="line">    import rich_click as click</span><br><span class="line">ModuleNotFoundError: No module named &#x27;rich_click&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>就去安装这个缺少的库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install rich-click -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p>接着就可以直接运行了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python &#x27;/home/kali/Desktop/esptool/esptool.py&#x27; -p /dev/ttyUSB0 -b 460800 --before default_reset --after hard_reset --chip esp32  write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/ble_ctf.bin</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>效果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"> ┌──(myenv)─(kali㉿kali)-[~/Desktop/ble_ctf]</span><br><span class="line">└─$ python &#x27;/home/kali/Desktop/esptool/esptool.py&#x27; -h                 </span><br><span class="line">                                                                                             </span><br><span class="line"> Usage: esptool.py [OPTIONS] COMMAND [ARGS]...                                               </span><br><span class="line">                                                                                             </span><br><span class="line"> esptool.py v4.8.1 - serial utility for flashing, provisioning, and interacting with         </span><br><span class="line"> Espressif SoCs.                                                                             </span><br><span class="line">                                                                                             </span><br><span class="line">╭─ Options ─────────────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ --chip              -c  [auto|esp8266|esp32|esp32s2|esp  Target chip type.                │</span><br><span class="line">│                         32s3|esp32c3|esp32c2|esp32c6|es                                   │</span><br><span class="line">│                         p32c61|esp32c5|esp32h2|esp32h21                                   │</span><br><span class="line">│                         |esp32p4|esp32h4]                                                 │</span><br><span class="line">│ --port              -p  TEXT                             Serial port device.              │</span><br><span class="line">│ --baud              -b  INTEGER                          Serial port baud rate used when  │</span><br><span class="line">│                                                          flashing/reading.                │</span><br><span class="line">│ --port-filter           [TEXT]                           Serial port device filter, can   │</span><br><span class="line">│                                                          be vid=NUMBER, pid=NUMBER,       │</span><br><span class="line">│                                                          name=SUBSTRING,                  │</span><br><span class="line">│                                                          serial=SUBSTRING.                │</span><br><span class="line">│ --before                [default-reset|usb-reset|no-res  Which reset to perform before    │</span><br><span class="line">│                         et|no-reset-no-sync]             connecting to the chip.          │</span><br><span class="line">│ --after             -a  [hard-reset|soft-reset|no-reset  Which reset to perform after     │</span><br><span class="line">│                         |no-reset-stub|watchdog-reset]   operation is finished.           │</span><br><span class="line">│ --no-stub                                                Disable launching the flasher    │</span><br><span class="line">│                                                          stub, only talk to ROM           │</span><br><span class="line">│                                                          bootloader. Some features will   │</span><br><span class="line">│                                                          not be available.                │</span><br><span class="line">│ --trace             -t                                   Enable trace-level output of     │</span><br><span class="line">│                                                          esptool.py interactions.         │</span><br><span class="line">│ --override-vddsdio      [1.8V|1.9V|OFF]                  Override ESP32 VDDSDIO internal  │</span><br><span class="line">│                                                          voltage regulator (use with      │</span><br><span class="line">│                                                          care).                           │</span><br><span class="line">│ --connect-attempts      INTEGER                          Number of attempts to connect,   │</span><br><span class="line">│                                                          negative or 0 for infinite.      │</span><br><span class="line">│                                                          Default: 7.                      │</span><br><span class="line">│ --help              -h                                   Show this message and exit.      │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─ Basic commands ──────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ write-flash             Write a binary blob to flash. The address is followed by binary   │</span><br><span class="line">│                         filename, separated by space.                                     │</span><br><span class="line">│ read-flash              Read SPI flash memory content.                                    │</span><br><span class="line">│ erase-flash             Erase the SPI flash memory.                                       │</span><br><span class="line">│ erase-region            Erase a region of the SPI flash memory.                           │</span><br><span class="line">│ read-mac                Print the device MAC address.                                     │</span><br><span class="line">│ flash-id                Print the SPI flash memory manufacturer and device ID.            │</span><br><span class="line">│ elf2image               Create an application image from ELF file                         │</span><br><span class="line">│ image-info              Print information about a firmware image (bootloader or           │</span><br><span class="line">│                         application).                                                     │</span><br><span class="line">│ merge-bin               Merge multiple raw binary files into a single flashable file.     │</span><br><span class="line">│ version                 Print esptool version.                                            │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─ Advanced commands ───────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ verify-flash            Verify a binary blob against the flash memory content.            │</span><br><span class="line">│ load-ram                Download an image to RAM and execute.                             │</span><br><span class="line">│ dump-mem                Dump arbitrary memory to a file.                                  │</span><br><span class="line">│ read-mem                Read arbitrary memory location.                                   │</span><br><span class="line">│ write-mem               Modify or write to arbitrary memory location.                     │</span><br><span class="line">│ read-flash-status       Read SPI flash memory status register.                            │</span><br><span class="line">│ write-flash-status      Write SPI flash memory status register.                           │</span><br><span class="line">│ read-flash-sfdp         Read SPI flash SFDP (Serial Flash Discoverable Parameters).       │</span><br><span class="line">│ get-security-info       Print security information report.                                │</span><br><span class="line">│ chip-id                 Print the device chip ID.                                         │</span><br><span class="line">│ run                     Run application code loaded in flash.                             │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">                                                                                             </span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop/ble_ctf]</span><br><span class="line">└─$ python &#x27;/home/kali/Desktop/esptool/esptool.py&#x27; -p /dev/ttyUSB0 -b 460800 --before default_reset --after hard_reset --chip esp32  write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/ble_ctf.bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning: Deprecated: Option &#x27;--flash_mode&#x27; is deprecated. Use &#x27;--flash-mode&#x27; instead.</span><br><span class="line">Warning: Deprecated: Option &#x27;--flash_size&#x27; is deprecated. Use &#x27;--flash-size&#x27; instead.</span><br><span class="line">Warning: Deprecated: Option &#x27;--flash_freq&#x27; is deprecated. Use &#x27;--flash-freq&#x27; instead.</span><br><span class="line">Warning: Deprecated: Choice &#x27;default_reset&#x27; for option &#x27;--before&#x27; is deprecated. Use &#x27;default-reset&#x27; instead.</span><br><span class="line">Warning: Deprecated: Choice &#x27;hard_reset&#x27; for option &#x27;--after&#x27; is deprecated. Use &#x27;hard-reset&#x27; instead.</span><br><span class="line">Warning: Deprecated: Command &#x27;write_flash&#x27; is deprecated. Use &#x27;write-flash&#x27; instead.</span><br><span class="line">esptool.py v4.8.1</span><br><span class="line">Connected to ESP32 on /dev/ttyUSB0:</span><br><span class="line">Chip type:          ESP32-D0WDQ6 (revision v1.1)</span><br><span class="line">Features:           Wi-Fi, BT, Dual Core + LP Core, 240MHz, Vref calibration in eFuse, Coding Scheme None</span><br><span class="line">Crystal frequency:  40MHz</span><br><span class="line">MAC:                8c:4f:00:c8:78:60</span><br><span class="line"></span><br><span class="line">Stub flasher running.</span><br><span class="line">Changing baud rate to 460800...</span><br><span class="line">Changed.</span><br><span class="line"></span><br><span class="line">Configuring flash size...</span><br><span class="line">Flash will be erased from 0x00001000 to 0x00007fff...</span><br><span class="line">Flash will be erased from 0x00008000 to 0x00008fff...</span><br><span class="line">Flash will be erased from 0x00010000 to 0x000cafff...</span><br><span class="line">SHA digest in image updated.</span><br><span class="line">Wrote 26464 bytes (16501 compressed) at 0x00001000 in 0.7 seconds (299.5 kbit/s).</span><br><span class="line">Hash of data verified.</span><br><span class="line">Wrote 3072 bytes (103 compressed) at 0x00008000 in 0.0 seconds (538.0 kbit/s).</span><br><span class="line">Hash of data verified.</span><br><span class="line">Wrote 765904 bytes (452895 compressed) at 0x00010000 in 11.0 seconds (559.3 kbit/s).</span><br><span class="line">Hash of data verified.</span><br><span class="line"></span><br><span class="line">Hard resetting via RTS pin...</span><br><span class="line">                                                                                             </span><br><span class="line">┌──(myenv)─(kali㉿kali)-[~/Desktop/ble_ctf]</span><br><span class="line">└─$ </span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="Connection-refused-111"><a href="#Connection-refused-111" class="headerlink" title="Connection refused (111)"></a>Connection refused (111)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">connect to 64:B7:08:61:B9:7E: Connection refused (111)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">connect to 64:B7:08:61:B9:7E: Connection refused (111)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先是排查功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo hciconfig hci0 lestates</span><br><span class="line">sudo hcitool lescan</span><br></pre></td></tr></table></figure>
<p>均正常输出</p>
<p>使用bluetooth进行交互</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查 bluetoothd 状态</span></span><br><span class="line">sudo systemctl status bluetooth</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动它</span></span><br><span class="line">sudo systemctl start bluetooth  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启它</span></span><br><span class="line">sudo systemctl restart bluetooth</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行它</span></span><br><span class="line">sudo bluetoothctl</span><br></pre></td></tr></table></figure>
<p>尝试进行交互</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">└─$ sudo bluetoothctl                                       </span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Agent registered</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line">Device 64:B7:08:61:B9:7E not available</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">SetDiscoveryFilter success</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Failed to start discovery: org.bluez.Error.InProgress</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在旁边另开一个终端，使用btmon进行底层HCI的查看<br>得到的部分日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@ MGMT Event: Command Complete (0x0001) plen 263  &#123;0x0001&#125; [hci0] 461.113935</span><br><span class="line">      Set Local Name (0x000f) plen 260</span><br><span class="line">        Status: Success (0x00)</span><br><span class="line">        Name: kali</span><br><span class="line">        Short name: </span><br><span class="line">bluetoothctl[24851]: @ MGMT..pen (privileged) version 1.23   &#123;0x0002&#125; 522.145845</span><br><span class="line">bluetoothctl[24851]: @ MGMT Close: bluetoothctl          &#123;0x0002&#125; 839.044348                                                   </span><br><span class="line">@ MGMT Event: Connect Failed (0x000d) plen 8      &#123;0x0001&#125; [hci0] 850.944326                                                   </span><br><span class="line">        LE Address: 64:B7:08:61:B9:7E (Espressif Inc.)                                                                         </span><br><span class="line">        Status: Disconnected (0x0e)                                                                                            </span><br><span class="line">@ MGMT Event: Connect Failed (0x000d) plen 8      &#123;0x0001&#125; [hci0] 897.298500                                                   </span><br><span class="line">        LE Address: 64:B7:08:61:B9:7E (Espressif Inc.)                                                                         </span><br><span class="line">        Status: Disconnected (0x0e)                                                                                            </span><br><span class="line">bluetoothctl[27969]: @ MGMT..pen (privileged) version 1.23   &#123;0x0002&#125; 901.948847                                               </span><br><span class="line">scanbluetoothd[24308]: @ MGMT Comm..d (0x0023) plen 1  &#123;0x0001&#125; [hci0] 919.350036                                              </span><br><span class="line">        Address type: 0x07                                                                                                     </span><br><span class="line">          BR/EDR                                                                                                               </span><br><span class="line">          LE Public                                                                                                            </span><br><span class="line">          LE Random</span><br><span class="line">@ MGMT Event: Command Complete (0x0001) plen 4    &#123;0x0001&#125; [hci0] 919.350060</span><br><span class="line">      Start Discovery (0x0023) plen 1</span><br><span class="line">        Status: Busy (0x0a)</span><br><span class="line">        Address type: 0x07</span><br><span class="line">          BR/EDR</span><br><span class="line">          LE Public</span><br><span class="line">          LE Random</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>给出的解决措施是重启蓝牙服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop bluetooth  # Stop the service first</span><br><span class="line">sleep 2                     # Give it a second to shut down</span><br><span class="line">sudo systemctl start bluetooth # Start it fresh</span><br><span class="line">sudo systemctl status bluetooth # Verify it&#x27;s active (running)</span><br></pre></td></tr></table></figure>
<p>还有蓝牙适配器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo hciconfig hci0 down</span><br><span class="line">sudo hciconfig hci0 up</span><br></pre></td></tr></table></figure>
<p>一顿重启后终于成功了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─$ sudo bluetoothctl</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Agent registered</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">SetDiscoveryFilter success</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">hci0 <span class="built_in">type</span> 7 discovering on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Discovery started</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Controller 84:E0:F4:03:0F:5E Discovering: <span class="built_in">yes</span></span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[NEW] Device 64:B7:08:61:B9:7E BLECTF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Operation-not-possible-due-to-RF-kill-132"><a href="#Operation-not-possible-due-to-RF-kill-132" class="headerlink" title="Operation not possible due to RF-kill (132)"></a>Operation not possible due to RF-kill (132)</h3><p>报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo hciconfig hci0 up  </span><br><span class="line">Can&#x27;t init device hci0: Operation not possible due to RF-kill (132)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>解决</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查蓝牙状况</span></span><br><span class="line">sudo rfkill list bluetooth</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解除软件阻塞 (Soft blocked):如果显示 <span class="string">&quot;Soft blocked: yes&quot;</span></span></span><br><span class="line">sudo rfkill unblock bluetooth</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解除所有类型的阻塞</span></span><br><span class="line">sudo rfkill unblock all</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>处理硬件阻塞 (Hard blocked):</strong> 如果显示 “Hard blocked: yes”，这意味着有一个<strong>物理开关</strong>（通常在笔记本电脑的侧面、前面或通过 Fn 组合键）关闭了蓝牙。你需要找到这个开关并<strong>物理上打开它</strong>。软件命令 (rfkill unblock) 无法解除硬件阻塞。</p>
<p>之后把蓝牙拔了又重新插回去就好了，重启大法妙呀（）</p>
<h3 id="Device-or-resource-busy-16"><a href="#Device-or-resource-busy-16" class="headerlink" title="Device or resource busy (16)"></a>Device or resource busy (16)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">connect to 64:B7:08:61:B9:7E: Device or resource busy (16)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>意味着你的蓝牙适配器 (hci0) <strong>已经被另一个应用程序或进程打开并独占使用了</strong><br>可能是没有完全退出的bluetoothctl或者gatttool服务<br>进行排查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ ps aux | grep bluetoothctl</span><br><span class="line">kali      202460  0.0  0.1   6520  2184 pts/0    S+   07:20   0:00 grep --color=auto bluetoothctl</span><br><span class="line"></span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ ps aux | grep gatttool</span><br><span class="line">kali      202840  0.0  0.1   6520  2336 pts/0    S+   07:21   0:00 grep --color=auto gatttool</span><br></pre></td></tr></table></figure>
<p>除了 grep 进程本身，没有其他名为 bluetoothctl &#x2F;gatttool的进程在运行。<br>所以依然是重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart bluetooth</span><br></pre></td></tr></table></figure>
<p>适配器也可以重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo hciconfig hci0 down</span><br><span class="line">sudo hciconfig hci0 up</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查状态，确保是 UP RUNNING</span></span><br><span class="line">hciconfig hci0</span><br></pre></td></tr></table></figure>





<h3 id="Device-64-B7-08-61-B9-7E-not-available"><a href="#Device-64-B7-08-61-B9-7E-not-available" class="headerlink" title="Device 64:B7:08:61:B9:7E not available"></a>Device 64:B7:08:61:B9:7E not available</h3><p>当一切都没有问题只有bluetoothctl有问题时，尝试scan on然后再scan off(记得关掉，因为前台没有显示但是用btmon看后台时它是一直在扫描的)，然后再连接就可以了,因为这强制更新了 bluetoothd 的设备状态缓存。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo bluetoothctl              </span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Agent registered</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line">Device 64:B7:08:61:B9:7E not available</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">[bluetooth]<span class="comment"># exit</span></span></span><br><span class="line">                                                                                                </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ gatttool -b 64:B7:08:61:B9:7E --char-read -a 0x0034|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the ascii value &quot;yo&quot; he</span><br><span class="line">                                                                                                </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo bluetoothctl</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Agent registered</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line">Device 64:B7:08:61:B9:7E not available</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">SetDiscoveryFilter success</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">hci0 <span class="built_in">type</span> 7 discovering on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Discovery started</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Controller 84:E0:F4:03:0F:5E Discovering: <span class="built_in">yes</span></span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[NEW] Device 64:B7:08:61:B9:7E BLECTF</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[NEW] Device 54:61:CC:20:CD:5B 54-61-CC-20-CD-5B</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan off[NEW] Device 50:81:5C:20:B9:E0 50-81-5C-20-B9-E0</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan off</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">hci0 <span class="built_in">type</span> 7 discovering off</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Discovery stopped</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 50:81:5C:20:B9:E0 TxPower is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 50:81:5C:20:B9:E0 RSSI is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 54:61:CC:20:CD:5B TxPower is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 54:61:CC:20:CD:5B RSSI is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 64:B7:08:61:B9:7E TxPower is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Device 64:B7:08:61:B9:7E RSSI is nil</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">[CHG] Controller 84:E0:F4:03:0F:5E Discovering: no</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line">Attempting to connect to 64:B7:08:61:B9:7E</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">hci0 64:B7:08:61:B9:7E <span class="built_in">type</span> LE Public connected eir_len 18</span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">[CHG] Device 64:B7:08:61:B9:7E Connected: <span class="built_in">yes</span></span></span><br><span class="line"><span class="meta prompt_">[BLECTF]# </span><span class="language-bash">Connection successful</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="Failed-to-start-discovery-org-bluez-Error-InProgress"><a href="#Failed-to-start-discovery-org-bluez-Error-InProgress" class="headerlink" title="Failed to start discovery: org.bluez.Error.InProgress"></a>Failed to start discovery: org.bluez.Error.InProgress</h3><p>尝试连接时的显示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ sudo bluetoothctl</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Agent registered</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">connect 64:B7:08:61:B9:7E</span></span><br><span class="line">Device 64:B7:08:61:B9:7E not available</span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">scan on</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">SetDiscoveryFilter success</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash">Failed to start discovery: org.bluez.Error.InProgress</span></span><br><span class="line"><span class="meta prompt_">[bluetooth]# </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br></pre></td></tr></table></figure>
<p>对应的btmon日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bluetoothctl[12451]: @ MGMT Open: bluetoothctl (privileged) version 1.23                                 &#123;0x0002&#125; 753.015752</span><br><span class="line">bluetoothd[8979]: @ MGMT Command: Start Discovery (0x0023) plen 1                                 &#123;0x0001&#125; [hci0] 775.725210</span><br><span class="line">        Address type: 0x07</span><br><span class="line">          BR/EDR</span><br><span class="line">          LE Public</span><br><span class="line">          LE Random</span><br><span class="line">@ MGMT Event: Command Complete (0x0001) plen 4                                                    &#123;0x0001&#125; [hci0] 775.725234</span><br><span class="line">      Start Discovery (0x0023) plen 1</span><br><span class="line">        Status: Busy (0x0a)</span><br><span class="line">        Address type: 0x07</span><br><span class="line">          BR/EDR</span><br><span class="line">          LE Public</span><br><span class="line">          LE Random</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>bluetoothd[8979]: @ MGMT Command: Start Discovery (0x0023) …: bluetoothd 确实通过管理接口向 hci0 发送了“启动发现”的命令。</p>
</li>
<li><p>@ MGMT Event: Command Complete (0x0001) … Start Discovery (0x0023) … Status: Busy (0x0a): <strong>这是关键。</strong> 蓝牙适配器 (hci0) 通过管理接口回复说，启动发现命令<strong>失败</strong>，因为适配器当前状态是 **Busy (忙碌，状态码 0x0a)**。</p>
</li>
</ul>
<p>措施依然是重启</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>靶场：<a class="link"   target="_blank" rel="noopener" href="https://github.com/hackgnar/ble_ctf" >https://github.com/hackgnar/ble_ctf<i class="fas fa-external-link-alt"></i></a><br>蓝牙知识扩展：<br><a class="link"   target="_blank" rel="noopener" href="https://www.bluetooth.com/" >https://www.bluetooth.com/<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://github.com/Eronwu/Getting-Started-with-Bluetooth-Low-Energy-in-Chinese" >https://github.com/Eronwu/Getting-Started-with-Bluetooth-Low-Energy-in-Chinese<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://github.com/pauloborges/bluez/blob/master/attrib/gatttool.c" >https://github.com/pauloborges/bluez/blob/master/attrib/gatttool.c<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://community.nxp.com/t5/Wireless-Connectivity-Knowledge/Indication-and-Notification/ta-p/1129270" >https://community.nxp.com/t5/Wireless-Connectivity-Knowledge/Indication-and-Notification/ta-p/1129270<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36347513/article/details/118762746" >https://blog.csdn.net/qq_36347513/article/details/118762746<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                
                        
<div class="post-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="copyright-post-title border-box text-ellipsis">
                ble_ctf wp
            </div>

            <div class="copyright-post-link border-box text-ellipsis">
                2025/04/26/从ble-ctf学蓝牙/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="copyright-post-author bottom-item">
                <div class="type">
                    作者
                </div>
                <div class="content">arch3rn4r</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    发布于
                </div>
                <div class="content">2025-04-26 17:53</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    许可
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank">
                        
                            <i class="fa-brands fa-creative-commons"></i>
                            <i class="fa-brands fa-creative-commons-by"></i>
                            <i class="fa-brands fa-creative-commons-nc"></i>
                            <i class="fa-brands fa-creative-commons-sa"></i>
                        
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="复制版权信息" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="分享到 QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="分享到微信"
            data-tooltip-img-tip="微信扫一扫"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="分享到微博"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2025/05/02/hello-world/"
                                   title="Hello World"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Hello World</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/04/19/%E5%9F%BA%E4%BA%8ELAN%E7%9A%84intent%E8%A7%A6%E5%8F%91/"
                                   title="基于LAN的intent触发"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">基于LAN的intent触发</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">评论插件加载失败</span>
    <button class="reload keep-button">点击重新加载</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">正在加载评论插件</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="giscus-comments-container">
        <div class="giscus" id="giscus"></div>
        <script 
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          if (!window.KeepCommentPlugin?.getGiscusTheme) {
            window.KeepCommentPlugin.getGiscusTheme = () => {
              return document.documentElement.classList.contains('dark-mode') ? 'dark_dimmed' : 'light_tritanopia'
            }
          }

          if (!window.KeepCommentPlugin?.changeGiscusTheme) {
            window.KeepCommentPlugin.changeGiscusTheme = () => {
              const iframe = document.querySelector('iframe.giscus-frame')
              iframe && iframe.contentWindow.postMessage({
                giscus: {
                  setConfig: {
                    theme: window.KeepCommentPlugin.getGiscusTheme()
                  }
                }
              }, 'https://giscus.app')
            }
          }

          if (!window.KeepCommentPlugin?.initGiscus) {
            window.KeepCommentPlugin.initGiscus = () => {
              const script = document.createElement('script')
              script.async = true
              script.src = 'https://giscus.app/client.js'
              script.setAttribute('data-repo', 'arch3rn4r/arch3rn4r.github.io')
              script.setAttribute('data-repo-id', 'R_kgDOLnMFhw')
              script.setAttribute('data-category', 'Announcements')
              script.setAttribute('data-category-id', 'DIC_kwDOLnMFh84Cik-D')
              script.setAttribute('data-reactions-enabled', '0')
              script.setAttribute('data-lang', 'zh-CN')
              script.setAttribute('data-mapping', 'pathname')
              script.setAttribute('data-strict', '0')
              script.setAttribute('data-emit-metadata', '0')
              script.setAttribute('data-input-position', 'top')
              script.setAttribute('crossorigin', 'anonymous')
              script.setAttribute('loading', 'lazy')
              script.setAttribute('data-theme', window.KeepCommentPlugin.getGiscusTheme())
              document.querySelector('.giscus-comments-container').appendChild(script)
              script.onerror = () => {
                window.KeepCommentPlugin.loadFailHandle()
              }
              script.onload = () => {
                window.KeepCommentPlugin.hideLoading()
              }
              const toggleThemeBtn = document.querySelector('.tool-toggle-theme-mode')
              toggleThemeBtn && toggleThemeBtn.addEventListener('click', () => {
                window.KeepCommentPlugin.changeGiscusTheme()
              })
            }
          }

          if ('false' === "true") {
            setTimeout(() => {
              window.KeepCommentPlugin.initGiscus()
            }, 1000)
          } else {
            window.addEventListener("DOMContentLoaded", window.KeepCommentPlugin.initGiscus)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc left-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0-%E5%89%8D%E6%9C%9F%E9%85%8D%E7%BD%AE"><span class="nav-text">0x0 前期配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x1"><span class="nav-text">0x1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-%E6%9F%A5%E7%9C%8B%E5%8F%8A%E6%8F%90%E4%BA%A4%E5%8F%A5%E6%9F%84"><span class="nav-text">0x2 查看及提交句柄</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3"><span class="nav-text">0x3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-%E6%9F%A5%E6%89%BE%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8F%A5%E6%9F%84"><span class="nav-text">0x4 查找指定的句柄</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E5%80%BC"><span class="nav-text">查找值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%8F%96"><span class="nav-text">进行读取</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x5%E4%BA%A4%E4%BA%92%E6%80%A7%E9%AA%8C%E8%AF%81"><span class="nav-text">0x5交互性验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x6-%E5%86%99%E5%85%A5ascii%E5%80%BC"><span class="nav-text">0x6 写入ascii值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gatttool"><span class="nav-text">1.gatttool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-bluetoothctl"><span class="nav-text">2.bluetoothctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%84%9A%E6%9C%AC"><span class="nav-text">3.脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x7-%E5%86%99%E5%85%A5hex%E5%80%BC"><span class="nav-text">0x7 写入hex值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gatttool-1"><span class="nav-text">1.gatttool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%84%9A%E6%9C%AC"><span class="nav-text">2.脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x8-%E6%8C%87%E5%AE%9A%E5%8F%A5%E6%9F%84%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">0x8 指定句柄的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x9-%E5%A4%9A%E6%AC%A1%E5%86%99"><span class="nav-text">0x9 多次写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x10-%E5%A4%9A%E6%AC%A1%E8%AF%BB"><span class="nav-text">0x10 多次读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E4%B8%80%E5%8D%83%E6%AC%A1shell%E6%93%8D%E4%BD%9C"><span class="nav-text">执行一千次shell操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bluepy"><span class="nav-text">bluepy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x11-%E8%AE%A2%E9%98%85gatt-notify"><span class="nav-text">0x11 订阅gatt notify</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5notify%E8%AE%BE%E7%BD%AE"><span class="nav-text">检查notify设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%9B%AE%E6%A0%87%E5%8F%A5%E6%9F%840x0040"><span class="nav-text">测试目标句柄0x0040</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x12-%E6%9F%A5%E7%9C%8Bgatt-indicate"><span class="nav-text">0x12 查看gatt indicate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x13-%E8%AF%BB%E5%8F%96%E5%A4%9A%E4%B8%AAnotify"><span class="nav-text">0x13 读取多个notify</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x14-%E8%AF%BB%E5%8F%96%E5%A4%9A%E4%B8%AAindicate"><span class="nav-text">0x14 读取多个indicate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x15-%E4%BF%AE%E6%94%B9%E8%93%9D%E7%89%99mac%E5%9C%B0%E5%9D%80"><span class="nav-text">0x15 修改蓝牙mac地址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bdaddr"><span class="nav-text">bdaddr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#btmgmt"><span class="nav-text">btmgmt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ifconnfig"><span class="nav-text">ifconnfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E4%BF%AE%E6%94%B9"><span class="nav-text">物理修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x16-%E8%AE%BE%E7%BD%AEMTU"><span class="nav-text">0x16 设置MTU</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8bluepy%E5%BA%93"><span class="nav-text">使用bluepy库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x17-%E5%86%99%E5%85%A5%E5%93%8D%E5%BA%94ack%E4%BF%A1%E6%81%AF"><span class="nav-text">0x17 写入响应ack信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x18-%E5%9B%BA%E4%BB%B6-is-boss"><span class="nav-text">0x18 固件 is boss</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x19-%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="nav-text">0x19 小总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x20"><span class="nav-text">0x20</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E6%8A%A5%E9%94%99"><span class="nav-text">记录报错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%97%B6%E6%8A%A5%E9%94%99"><span class="nav-text">安装时报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-refused-111"><span class="nav-text">Connection refused (111)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Operation-not-possible-due-to-RF-kill-132"><span class="nav-text">Operation not possible due to RF-kill (132)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-or-resource-busy-16"><span class="nav-text">Device or resource busy (16)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-64-B7-08-61-B9-7E-not-available"><span class="nav-text">Device 64:B7:08:61:B9:7E not available</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Failed-to-start-discovery-org-bluez-Error-InProgress"><span class="nav-text">Failed to start discovery: org.bluez.Error.InProgress</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">arch3rn4r</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">78.1k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">访客数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools left-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0-%E5%89%8D%E6%9C%9F%E9%85%8D%E7%BD%AE"><span class="nav-text">0x0 前期配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x1"><span class="nav-text">0x1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x2-%E6%9F%A5%E7%9C%8B%E5%8F%8A%E6%8F%90%E4%BA%A4%E5%8F%A5%E6%9F%84"><span class="nav-text">0x2 查看及提交句柄</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x3"><span class="nav-text">0x3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x4-%E6%9F%A5%E6%89%BE%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8F%A5%E6%9F%84"><span class="nav-text">0x4 查找指定的句柄</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E5%80%BC"><span class="nav-text">查找值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%8F%96"><span class="nav-text">进行读取</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x5%E4%BA%A4%E4%BA%92%E6%80%A7%E9%AA%8C%E8%AF%81"><span class="nav-text">0x5交互性验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x6-%E5%86%99%E5%85%A5ascii%E5%80%BC"><span class="nav-text">0x6 写入ascii值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gatttool"><span class="nav-text">1.gatttool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-bluetoothctl"><span class="nav-text">2.bluetoothctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%84%9A%E6%9C%AC"><span class="nav-text">3.脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x7-%E5%86%99%E5%85%A5hex%E5%80%BC"><span class="nav-text">0x7 写入hex值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gatttool-1"><span class="nav-text">1.gatttool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%84%9A%E6%9C%AC"><span class="nav-text">2.脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x8-%E6%8C%87%E5%AE%9A%E5%8F%A5%E6%9F%84%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">0x8 指定句柄的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x9-%E5%A4%9A%E6%AC%A1%E5%86%99"><span class="nav-text">0x9 多次写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x10-%E5%A4%9A%E6%AC%A1%E8%AF%BB"><span class="nav-text">0x10 多次读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E4%B8%80%E5%8D%83%E6%AC%A1shell%E6%93%8D%E4%BD%9C"><span class="nav-text">执行一千次shell操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bluepy"><span class="nav-text">bluepy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x11-%E8%AE%A2%E9%98%85gatt-notify"><span class="nav-text">0x11 订阅gatt notify</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5notify%E8%AE%BE%E7%BD%AE"><span class="nav-text">检查notify设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%9B%AE%E6%A0%87%E5%8F%A5%E6%9F%840x0040"><span class="nav-text">测试目标句柄0x0040</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x12-%E6%9F%A5%E7%9C%8Bgatt-indicate"><span class="nav-text">0x12 查看gatt indicate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x13-%E8%AF%BB%E5%8F%96%E5%A4%9A%E4%B8%AAnotify"><span class="nav-text">0x13 读取多个notify</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x14-%E8%AF%BB%E5%8F%96%E5%A4%9A%E4%B8%AAindicate"><span class="nav-text">0x14 读取多个indicate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x15-%E4%BF%AE%E6%94%B9%E8%93%9D%E7%89%99mac%E5%9C%B0%E5%9D%80"><span class="nav-text">0x15 修改蓝牙mac地址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bdaddr"><span class="nav-text">bdaddr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#btmgmt"><span class="nav-text">btmgmt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ifconnfig"><span class="nav-text">ifconnfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E4%BF%AE%E6%94%B9"><span class="nav-text">物理修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x16-%E8%AE%BE%E7%BD%AEMTU"><span class="nav-text">0x16 设置MTU</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8bluepy%E5%BA%93"><span class="nav-text">使用bluepy库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x17-%E5%86%99%E5%85%A5%E5%93%8D%E5%BA%94ack%E4%BF%A1%E6%81%AF"><span class="nav-text">0x17 写入响应ack信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x18-%E5%9B%BA%E4%BB%B6-is-boss"><span class="nav-text">0x18 固件 is boss</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x19-%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="nav-text">0x19 小总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x20"><span class="nav-text">0x20</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E6%8A%A5%E9%94%99"><span class="nav-text">记录报错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%97%B6%E6%8A%A5%E9%94%99"><span class="nav-text">安装时报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-refused-111"><span class="nav-text">Connection refused (111)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Operation-not-possible-due-to-RF-kill-132"><span class="nav-text">Operation not possible due to RF-kill (132)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-or-resource-busy-16"><span class="nav-text">Device or resource busy (16)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-64-B7-08-61-B9-7E-not-available"><span class="nav-text">Device 64:B7:08:61:B9:7E not available</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Failed-to-start-discovery-org-bluez-Error-InProgress"><span class="nav-text">Failed to start discovery: org.bluez.Error.InProgress</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/post/copyright-info.min.js"></script>
        

        <!-- share -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.3/js/post/share.min.js"></script>
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



    
        
    

</body>
</html>
